{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Segment Routing","text":"Implementing Segment Routing with TI-LFA on Cisco XRv9k platform"},{"location":"#objective","title":"Objective","text":"<p>The objective of this workshop is to run through a few SR MPLS Tutorials scenarios in the lab.</p> <p>Thank you so much to the team for putting up the tutorials.</p> <p>Must Read</p> <p>Because the purpose of the lab is to get practical experience, it is strongly recommended that you study those PDFs before joining the lab. The theory is not discussed in depth, and the majority of the guide is self-explanatory.</p> <p>Out of Scope</p> <p>The guide tries to cover the bare necessities for putting SR-ISIS and TI-LFA into action. The scope excludes SR-TE, Flex-Algo, and Delay Measurement.</p>"},{"location":"#topology-overview","title":"Topology Overview","text":"Base Topology <ul> <li>The routers are all Cisco XRv9ks running 7.5.2 and are managed by the netdevops server1.</li> <li>The guide starts with ISIS IGP and LDP configurations as the base transport, and each section progresses from the base state to the introduction of Segment Routing, eventually leading to a seamless migration to SR with TI-LFA.</li> <li>The remaining scenarios would then put to the test the SR-ISIS transport reachability and TI-LFA-based FRR protection (variants thereof) from PE1 to PE5 or P2 to PE5.</li> <li>A new router P9 would be put between P2 and P3 later in the tutorial.</li> </ul> <ol> <li> <p>This lab is running in EVE-NG Pro.\u00a0\u21a9</p> </li> </ol>"},{"location":"ds_tilfa/","title":"Double Segment TI-LFA (Topology Independent - LoopFree Alternate)","text":"Double Segment TI-LFA <p>Double Segment TI-LFA is a backup route in which the router delivers traffic to the destination after adding two additional segment to the original segment in the event of a local link failure.</p>"},{"location":"ds_tilfa/#prepare-the-topology","title":"Prepare the topology","text":"<p>Change the metric between P8 and P4 in the same topology used for single segment ti-lfa to 100.</p> P8P4 <pre><code>router isis IGP\ninterface GigabitEthernet0/0/0/1\naddress-family ipv4 unicast\nmetric 100\n</code></pre> <pre><code>router isis IGP\n interface GigabitEthernet0/0/0/1\n  address-family ipv4 unicast\n   metric 100\n</code></pre>"},{"location":"ds_tilfa/#verify","title":"Verify","text":"P2's P-spaceP-space of P6 (P2's neighbor)Extended P-space of P2, with respect to P2 - P3 link <pre><code>Routers P2 can reach without using P2 - P3 link (excluding ECMP)\n    1. P6\n    2. P7\n</code></pre> <pre><code>Routers P6 can reach without using P2 - P3 link\n    1. P7\n    2. P8\n</code></pre> <pre><code>1. P6\n2. P7\n3. P8\n</code></pre> Q-space of PE5 <pre><code>Routers which can reach PE5 without using P2 - P3 link (excluding ECMP)\n    1. P4\n</code></pre> <p>There is no PQ router, which is in both Extended-P-Space and Q-Space.</p> <p>The traffic now needs to be directed from the P-node to the Q-node, by using the Adj-SID label of the link on the P-node, towards the Q-node.</p> <p>Because all routers advertise their Prefix-SID index and Adj-SID value in the ISIS LSP, P2 is aware of the Adj-SID of the P8 - P4 link.</p> <p>P2 forms a label stack for the backup path\u00a0using Adj-SID information from its ISIS LSDB to direct traffic to the target on the post-convergence path.</p> <p>P8 is located in P-space (or P-node) (P2 can send traffic to P8 without any risk of it flowing via P2 \u2013 P-RR3).</p> <p>P4 is located in Q-space (or Q-node) (P4 can send the traffic to the destination without any risk of it flowing via P2 \u2013 P-RR3)</p> P8 to PE5 via P2 - P3 <pre><code>RP/0/RP0/CPU0:P8#traceroute sr-mpls 5.5.5.5/32\nWed Feb  1 07:37:11.392 UTC\nTracing MPLS Label Switched Path to 5.5.5.5/32, timeout is 2 seconds\nCodes: '!' - success, 'Q' - request not sent, '.' - timeout,\n'L' - labeled output interface, 'B' - unlabeled output interface,\n'D' - DS Map mismatch, 'F' - no FEC mapping, 'f' - FEC mismatch,\n'M' - malformed request, 'm' - unsupported tlvs, 'N' - no rx label,\n'P' - no rx intf label prot, 'p' - premature termination of LSP,\n'R' - transit router, 'I' - unknown upstream index,\n'X' - unknown return code, 'x' - return code 0\nType escape sequence to abort.\n0 78.0.0.8 MRU 1500 [Labels: 16005 Exp: 0]\nL 1 78.0.0.7 MRU 1500 [Labels: 16005 Exp: 0] 10 ms\nL 2 67.0.0.6 MRU 1500 [Labels: 16005 Exp: 0] 19 ms\nL 3 26.0.0.2 MRU 1500 [Labels: 16005 Exp: 0] 10 ms\nL 4 23.0.0.3 MRU 1500 [Labels: 16005 Exp: 0] 14 ms\nL 5 34.0.0.4 MRU 1500 [Labels: implicit-null Exp: 0] 11 ms\n! 6 45.0.0.5 19 ms\nRP/0/RP0/CPU0:P8#\n</code></pre> P8 Adjacencny-SID to P4 <pre><code>RP/0/RP0/CPU0:P8#show isis adjacency detail\nWed Feb  1 07:37:15.047 UTC\nIS-IS IGP Level-2 adjacencies:\nSystem Id      Interface                SNPA           State Hold Changed  NSF IPv4 IPv6\nBFD  BFD\nP4             Gi0/0/0/1                *PtoP*         Up    29   04:39:48 Yes None None\nArea Address:           49\nNeighbor IPv4 Address:  48.0.0.4*\nAdjacency SID:          24016 (protected)\nBackup label stack:    [16004]\nBackup stack size:     1\nBackup interface:      Gi0/0/0/2\nBackup nexthop:        78.0.0.7\nBackup node address:   4.4.4.4\nNon-FRR Adjacency SID:  24017\nTopology:               IPv4 Unicast\nBFD Status:             BFD Not Required, Neighbor Useable\n&lt;..snipped..&gt;\n</code></pre> Double Segment TI-LFA <pre><code>RP/0/RP0/CPU0:P2#show isis fast-reroute 5.5.5.5/32 detail\nWed Feb  1 07:37:33.441 UTC\nL2 5.5.5.5/32 [30/115] Label: 16005, medium priority\nInstalled Feb 01 07:35:51.435 for 00:01:42\nvia 23.0.0.3, GigabitEthernet0/0/0/0, Label: 16005, P3, SRGB Base: 16000, Weight: 0\nBackup path: TI-LFA (link), via 26.0.0.6, GigabitEthernet0/0/0/1 P6, SRGB Base: 16000, Weight: 0, Metric: 140\nP node: P8.00 [8.8.8.8], Label: 16008\nQ node: P4.00 [4.4.4.4], Label: 24017   // (1)\nPrefix label: 16005                    Backup-src: PE5.00\nP: No, TM: 140, LC: No, NP: No, D: No, SRLG: Yes\nsrc PE5.00-00, 5.5.5.5, prefix-SID index 5, R:0 N:1 P:0 E:0 V:0 L:0, Alg:0\nRP/0/RP0/CPU0:P2#\nRP/0/RP0/CPU0:P2#show cef 5.5.5.5/32\nWed Feb  1 07:37:45.928 UTC\n5.5.5.5/32, version 468, labeled SR, internal 0x1000001 0x8310 (ptr 0xe727de0) [1], 0x600 (0xe190578), 0xa28 (0xf54aaf8)\nUpdated Feb  1 07:35:51.441\nremote adjacency to GigabitEthernet0/0/0/0\nPrefix Len 32, traffic index 0, precedence n/a, priority 1\ngateway array (0xdff9d60) reference count 6, flags 0x500068, source rib (7), 1 backups\n[3 type 5 flags 0x8401 (0xeb73f48) ext 0x0 (0x0)]\nLW-LDI[type=5, refc=3, ptr=0xe190578, sh-ldi=0xeb73f48]\ngateway array update type-time 1 Feb  1 07:35:51.441\nLDI Update time Feb  1 07:35:51.447\nLW-LDI-TS Feb  1 07:35:51.447\nvia 23.0.0.3/32, GigabitEthernet0/0/0/0, 10 dependencies, weight 0, class 0, protected [flags 0x400]\npath-idx 0 bkup-idx 1 NHID 0x0 [0xdda5820 0x0]\nnext hop 23.0.0.3/32\nlocal label 16005      labels imposed {16005}\nvia 26.0.0.6/32, GigabitEthernet0/0/0/1, 11 dependencies, weight 0, class 0, backup (TI-LFA) [flags 0xb00]\npath-idx 1 NHID 0x0 [0xf399970 0x0]\nnext hop 26.0.0.6/32, Repair Node(s): 8.8.8.8, 4.4.4.4\nremote adjacency\nlocal label 16005      labels imposed {16008 24017 16005}  // (2)\nLoad distribution: 0 (refcount 3)\nHash  OK  Interface                 Address\n0     Y   GigabitEthernet0/0/0/0    remote\nRP/0/RP0/CPU0:P2#\n</code></pre> <ol> <li>P8's Adj-SID label to P4 is used to direct the backup path to PE5</li> <li>Backup path is sent to P8 and then directed to P4 </li> </ol>"},{"location":"ds_tilfa/#restore-the-metrics","title":"Restore the metrics","text":"P8P4 <pre><code>router isis IGP\ninterface GigabitEthernet0/0/0/1\naddress-family ipv4 unicast\nmetric 10\n</code></pre> <pre><code>router isis IGP\ninterface GigabitEthernet0/0/0/1\naddress-family ipv4 unicast\nmetric 10\n</code></pre>"},{"location":"ip_add/","title":"IP Address","text":""},{"location":"ip_add/#configuration","title":"Configuration","text":"PE1P2P3P4PE5P6P7P8 <pre><code>interface Loopback0\nipv4 address 1.1.1.1 255.255.255.255\n!\ninterface GigabitEthernet0/0/0/2\nipv4 address 12.0.0.1 255.255.255.0\nno shutdown\n</code></pre> <pre><code>interface Loopback0\nipv4 address 2.2.2.2 255.255.255.255\n!\ninterface GigabitEthernet0/0/0/0\nipv4 address 23.0.0.2 255.255.255.0\nno shutdown\n!\ninterface GigabitEthernet0/0/0/1\nipv4 address 26.0.0.2 255.255.255.0\nno shutdown\n!\ninterface GigabitEthernet0/0/0/2\nipv4 address 12.0.0.2 255.255.255.0\nno shutdown\n!\ninterface GigabitEthernet0/0/0/3\nipv4 address 27.0.0.2 255.255.255.0\nno shutdown\n!\n</code></pre> <pre><code>interface Loopback0\nipv4 address 3.3.3.3 255.255.255.255\n!\ninterface GigabitEthernet0/0/0/0\nipv4 address 23.0.0.3 255.255.255.0\nno shutdown\n!\ninterface GigabitEthernet0/0/0/1\nipv4 address 37.0.0.3 255.255.255.0\nno shutdown\n!\ninterface GigabitEthernet0/0/0/2\nipv4 address 34.0.0.3 255.255.255.0\nno shutdown\n</code></pre> <pre><code>interface Loopback0\nipv4 address 4.4.4.4 255.255.255.255\n!\ninterface GigabitEthernet0/0/0/0\nipv4 address 45.0.0.4 255.255.255.0\nno shutdown\n!\ninterface GigabitEthernet0/0/0/1\nipv4 address 48.0.0.4 255.255.255.0\nno shutdown\n!\ninterface GigabitEthernet0/0/0/2\nipv4 address 34.0.0.4 255.255.255.0\nno shutdown\n!\ninterface GigabitEthernet0/0/0/4\nipv4 address 47.0.0.4 255.255.255.0\nno shutdown\n</code></pre> <pre><code>interface Loopback0\nipv4 address 5.5.5.5 255.255.255.255\n!\ninterface GigabitEthernet0/0/0/0\nipv4 address 45.0.0.5 255.255.255.0\nno shutdown\n</code></pre> <pre><code>interface Loopback0\nipv4 address 6.6.6.6 255.255.255.255\n!\ninterface GigabitEthernet0/0/0/0\nipv4 address 67.0.0.6 255.255.255.0\nno shutdown\n!\ninterface GigabitEthernet0/0/0/1\nipv4 address 26.0.0.6 255.255.255.0\nno shutdown\n</code></pre> <pre><code>interface Loopback0\nipv4 address 7.7.7.7 255.255.255.255\n!\ninterface GigabitEthernet0/0/0/0\nipv4 address 67.0.0.7 255.255.255.0\nno shutdown\n!\ninterface GigabitEthernet0/0/0/1\nipv4 address 37.0.0.7 255.255.255.0\nno shutdown\n!\ninterface GigabitEthernet0/0/0/2\nipv4 address 78.0.0.7 255.255.255.0\nno shutdown\n!\ninterface GigabitEthernet0/0/0/3\nipv4 address 27.0.0.7 255.255.255.0\nno shutdown\n!\ninterface GigabitEthernet0/0/0/4\nipv4 address 47.0.0.7 255.255.255.0\nno shutdown\n</code></pre> <pre><code>interface Loopback0\nipv4 address 8.8.8.8 255.255.255.255\n!\ninterface GigabitEthernet0/0/0/1\nipv4 address 48.0.0.8 255.255.255.0\nno shutdown\n!\ninterface GigabitEthernet0/0/0/2\nipv4 address 78.0.0.8 255.255.255.0\nno shutdown\n</code></pre>"},{"location":"ip_add/#verify","title":"Verify","text":"IP Address <pre><code>RP/0/RP0/CPU0:PE1#show ip int brief\nWed Feb  1 02:59:30.713 UTC\nInterface                      IP-Address      Status          Protocol Vrf-Name\nLoopback0                      1.1.1.1         Up              Up       default\nMgmtEth0/RP0/CPU0/0            192.168.18.1    Up              Up       default\nGigabitEthernet0/0/0/0         unassigned      Shutdown        Down     default\nGigabitEthernet0/0/0/1         unassigned      Shutdown        Down     default\nGigabitEthernet0/0/0/2         12.0.0.1        Up              Up       default\nGigabitEthernet0/0/0/3         unassigned      Shutdown        Down     default\nGigabitEthernet0/0/0/4         unassigned      Shutdown        Down     default\nGigabitEthernet0/0/0/5         unassigned      Shutdown        Down     default\nGigabitEthernet0/0/0/6         unassigned      Shutdown        Down     default\nGigabitEthernet0/0/0/7         unassigned      Shutdown        Down     default\nRP/0/RP0/CPU0:PE1#\nRP/0/RP0/CPU0:PE1#ping 12.0.0.2\nWed Feb  1 03:02:30.713 UTC\nType escape sequence to abort.\nSending 5, 100-byte ICMP Echos to 12.0.0.2, timeout is 2 seconds:\n!!!!!\nSuccess rate is 100 percent (5/5), round-trip min/avg/max = 3/6/15 ms\nRP/0/RP0/CPU0:PE1#\n</code></pre>"},{"location":"isis/","title":"Routing (ISIS)","text":""},{"location":"isis/#configuration","title":"Configuration","text":"<p>NET Schema</p> <p>The ISIS NET schema for each node is : 49.0000.0000.000x.00, where x is the number associated with the router in the base topology image.</p> PE1P2P3P4PE5P6P7P8 <pre><code>router isis IGP\nis-type level-2-only\nnet 49.0000.0000.0001.00\nlog adjacency changes\naddress-family ipv4 unicast\nmetric-style wide level 2\n!\ninterface Loopback0\npassive\naddress-family ipv4 unicast\n!\n!\ninterface GigabitEthernet0/0/0/2\ncircuit-type level-2-only\npoint-to-point\nhello-padding disable\naddress-family ipv4 unicast\nmetric 10\n</code></pre> <pre><code>router isis IGP\nis-type level-2-only\nnet 49.0000.0000.0002.00\nlog adjacency changes\naddress-family ipv4 unicast\nmetric-style wide level 2\n!\ninterface Loopback0\npassive\naddress-family ipv4 unicast\n!\n!\ninterface GigabitEthernet0/0/0/0\ncircuit-type level-2-only\npoint-to-point\nhello-padding disable\naddress-family ipv4 unicast\nmetric 10\n!\n!\ninterface GigabitEthernet0/0/0/1\ncircuit-type level-2-only\npoint-to-point\nhello-padding disable\naddress-family ipv4 unicast\nmetric 10\n!\n!\ninterface GigabitEthernet0/0/0/2\ncircuit-type level-2-only\npoint-to-point\nhello-padding disable\naddress-family ipv4 unicast\nmetric 10\n!\n!\ninterface GigabitEthernet0/0/0/3\ncircuit-type level-2-only\npoint-to-point\nhello-padding disable\naddress-family ipv4 unicast\nmetric 10\n</code></pre> <pre><code>router isis IGP\nis-type level-2-only\nnet 49.0000.0000.0003.00\nlog adjacency changes\naddress-family ipv4 unicast\nmetric-style wide level 2\n!\ninterface Loopback0\npassive\naddress-family ipv4 unicast\n!\n!\ninterface GigabitEthernet0/0/0/0\ncircuit-type level-2-only\npoint-to-point\nhello-padding disable\naddress-family ipv4 unicast\nmetric 10\n!\n!\ninterface GigabitEthernet0/0/0/1\ncircuit-type level-2-only\npoint-to-point\nhello-padding disable\naddress-family ipv4 unicast\nmetric 10\n!\n!\ninterface GigabitEthernet0/0/0/2\ncircuit-type level-2-only\npoint-to-point\nhello-padding disable\naddress-family ipv4 unicast\nmetric 10\n</code></pre> <pre><code>router isis IGP\nis-type level-2-only\nnet 49.0000.0000.0004.00\nlog adjacency changes\naddress-family ipv4 unicast\nmetric-style wide level 2\n!\ninterface Loopback0\npassive\naddress-family ipv4 unicast\n!\n!\ninterface GigabitEthernet0/0/0/0\ncircuit-type level-2-only\npoint-to-point\nhello-padding disable\naddress-family ipv4 unicast\nmetric 10\n!\n!\ninterface GigabitEthernet0/0/0/1\ncircuit-type level-2-only\npoint-to-point\nhello-padding disable\naddress-family ipv4 unicast\nmetric 10\n!\n!\ninterface GigabitEthernet0/0/0/2\ncircuit-type level-2-only\npoint-to-point\nhello-padding disable\naddress-family ipv4 unicast\nmetric 10\n!\n!\ninterface GigabitEthernet0/0/0/4\ncircuit-type level-2-only\npoint-to-point\nhello-padding disable\naddress-family ipv4 unicast\nmetric 10\n</code></pre> <pre><code>router isis IGP\nis-type level-2-only\nnet 49.0000.0000.0005.00\nlog adjacency changes\naddress-family ipv4 unicast\nmetric-style wide level 2\n!\ninterface Loopback0\npassive\naddress-family ipv4 unicast\n!\n!\ninterface GigabitEthernet0/0/0/0\ncircuit-type level-2-only\npoint-to-point\nhello-padding disable\naddress-family ipv4 unicast\nmetric 10\n</code></pre> <pre><code>router isis IGP\nis-type level-2-only\nnet 49.0000.0000.0006.00\nlog adjacency changes\naddress-family ipv4 unicast\nmetric-style wide level 2\n!\ninterface Loopback0\npassive\naddress-family ipv4 unicast\n!\n!\ninterface GigabitEthernet0/0/0/0\ncircuit-type level-2-only\npoint-to-point\nhello-padding disable\naddress-family ipv4 unicast\nmetric 10\n!\n!\ninterface GigabitEthernet0/0/0/1\ncircuit-type level-2-only\npoint-to-point\nhello-padding disable\naddress-family ipv4 unicast\nmetric 10\n</code></pre> <pre><code>router isis IGP\nis-type level-2-only\nnet 49.0000.0000.0007.00\nlog adjacency changes\naddress-family ipv4 unicast\nmetric-style wide level 2\n!\ninterface Loopback0\npassive\naddress-family ipv4 unicast\n!\n!\ninterface GigabitEthernet0/0/0/0\ncircuit-type level-2-only\npoint-to-point\nhello-padding disable\naddress-family ipv4 unicast\nmetric 10\n!\n!\ninterface GigabitEthernet0/0/0/1\ncircuit-type level-2-only\npoint-to-point\nhello-padding disable\naddress-family ipv4 unicast\nmetric 10\n!\n!\ninterface GigabitEthernet0/0/0/2\ncircuit-type level-2-only\npoint-to-point\nhello-padding disable\naddress-family ipv4 unicast\nmetric 10\n!\n!\ninterface GigabitEthernet0/0/0/3\ncircuit-type level-2-only\npoint-to-point\nhello-padding disable\naddress-family ipv4 unicast\nmetric 10\n!\n!\ninterface GigabitEthernet0/0/0/4\ncircuit-type level-2-only\npoint-to-point\nhello-padding disable\naddress-family ipv4 unicast\nmetric 10\n</code></pre> <pre><code>router isis IGP\nis-type level-2-only\nnet 49.0000.0000.0008.00\nlog adjacency changes\naddress-family ipv4 unicast\nmetric-style wide level 2\n!\ninterface Loopback0\npassive\naddress-family ipv4 unicast\n!\n!\ninterface GigabitEthernet0/0/0/1\ncircuit-type level-2-only\npoint-to-point\nhello-padding disable\naddress-family ipv4 unicast\nmetric 10\n!\n!\ninterface GigabitEthernet0/0/0/2\ncircuit-type level-2-only\npoint-to-point\nhello-padding disable\naddress-family ipv4 unicast\nmetric 10\n</code></pre>"},{"location":"isis/#verify","title":"Verify","text":"Routing Table <pre><code>RP/0/RP0/CPU0:PE1#show route\nWed Feb  1 05:43:59.895 UTC\nCodes: C - connected, S - static, R - RIP, B - BGP, (&gt;) - Diversion path\nD - EIGRP, EX - EIGRP external, O - OSPF, IA - OSPF inter area\nN1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2\nE1 - OSPF external type 1, E2 - OSPF external type 2, E - EGP\ni - ISIS, L1 - IS-IS level-1, L2 - IS-IS level-2\nia - IS-IS inter area, su - IS-IS summary null, * - candidate default\nU - per-user static route, o - ODR, L - local, G  - DAGR, l - LISP\nA - access/subscriber, a - Application route\nM - mobile route, r - RPL, t - Traffic Engineering, (!) - FRR Backup path\nGateway of last resort is not set\nL    1.1.1.1/32 is directly connected, 02:46:30, Loopback0\ni L2 2.2.2.2/32 [115/10] via 12.0.0.2, 02:45:29, GigabitEthernet0/0/0/2\ni L2 3.3.3.3/32 [115/20] via 12.0.0.2, 02:45:29, GigabitEthernet0/0/0/2\ni L2 4.4.4.4/32 [115/30] via 12.0.0.2, 02:45:29, GigabitEthernet0/0/0/2\ni L2 5.5.5.5/32 [115/40] via 12.0.0.2, 02:45:29, GigabitEthernet0/0/0/2\ni L2 6.6.6.6/32 [115/20] via 12.0.0.2, 02:45:29, GigabitEthernet0/0/0/2\ni L2 7.7.7.7/32 [115/20] via 12.0.0.2, 02:45:29, GigabitEthernet0/0/0/2\ni L2 8.8.8.8/32 [115/30] via 12.0.0.2, 02:45:29, GigabitEthernet0/0/0/2\nC    12.0.0.0/24 is directly connected, 02:45:39, GigabitEthernet0/0/0/2\nL    12.0.0.1/32 is directly connected, 02:45:39, GigabitEthernet0/0/0/2\ni L2 23.0.0.0/24 [115/20] via 12.0.0.2, 02:45:29, GigabitEthernet0/0/0/2\ni L2 26.0.0.0/24 [115/20] via 12.0.0.2, 02:45:29, GigabitEthernet0/0/0/2\ni L2 27.0.0.0/24 [115/20] via 12.0.0.2, 02:45:29, GigabitEthernet0/0/0/2\ni L2 34.0.0.0/24 [115/30] via 12.0.0.2, 02:45:29, GigabitEthernet0/0/0/2\ni L2 37.0.0.0/24 [115/30] via 12.0.0.2, 02:45:29, GigabitEthernet0/0/0/2\ni L2 45.0.0.0/24 [115/40] via 12.0.0.2, 02:45:29, GigabitEthernet0/0/0/2\ni L2 47.0.0.0/24 [115/30] via 12.0.0.2, 02:45:29, GigabitEthernet0/0/0/2\ni L2 48.0.0.0/24 [115/40] via 12.0.0.2, 02:45:29, GigabitEthernet0/0/0/2\ni L2 67.0.0.0/24 [115/30] via 12.0.0.2, 02:45:29, GigabitEthernet0/0/0/2\ni L2 78.0.0.0/24 [115/30] via 12.0.0.2, 02:45:29, GigabitEthernet0/0/0/2\nL    127.0.0.0/8 [0/0] via 0.0.0.0, 02:46:33\nC    192.168.18.0/24 is directly connected, 02:46:27, MgmtEth0/RP0/CPU0/0\nL    192.168.18.1/32 is directly connected, 02:46:27, MgmtEth0/RP0/CPU0/0\nRP/0/RP0/CPU0:PE1#\nRP/0/RP0/CPU0:PE1#show isis route 5.5.5.5/32 detail\nWed Feb  1 05:44:24.867 UTC\nL2 5.5.5.5/32 [40/115] Label: None, medium priority\nInstalled Feb 01 02:58:30.358 for 02:45:54\nvia 12.0.0.2, GigabitEthernet0/0/0/2, P2, Weight: 0\nsrc PE5.00-00, 5.5.5.5\nRP/0/RP0/CPU0:PE1#\nRP/0/RP0/CPU0:PE1#show route 5.5.5.5/32 detail\nWed Feb  1 05:44:45.325 UTC\nRouting entry for 5.5.5.5/32\nKnown via \"isis IGP\", distance 115, metric 40, type level-2\nInstalled Feb  1 02:58:30.358 for 02:46:15\nRouting Descriptor Blocks\n12.0.0.2, from 5.5.5.5, via GigabitEthernet0/0/0/2\nRoute metric is 40\nLabel: None\nTunnel ID: None\nBinding Label: None\nExtended communities count: 0\nPath id:1       Path ref count:0\nNHID:0x1(Ref:18)\nRoute version is 0x1 (1)\nNo local label\nIP Precedence: Not Set\nQoS Group ID: Not Set\nFlow-tag: Not Set\nFwd-class: Not Set\nRoute Priority: RIB_PRIORITY_NON_RECURSIVE_MEDIUM (7) SVD Type RIB_SVD_TYPE_LOCAL\nDownload Priority 1, Download Version 18\nNo advertising protos.\nRP/0/RP0/CPU0:PE1#\n</code></pre>"},{"location":"ldp/","title":"MPLS (LDP)","text":""},{"location":"ldp/#configuration","title":"Configuration","text":"All Routers <pre><code>router isis IGP\naddress-family ipv4 unicast\nmpls ldp auto-config\n!\n!\nmpls oam\n!\nmpls ldp\nlog\nneighbor\n</code></pre>"},{"location":"ldp/#verify","title":"Verify","text":"LDP Forwarding <pre><code>RP/0/RP0/CPU0:PE1#show mpls label table\nWed Feb  1 05:45:35.286 UTC\nTable Label   Owner                           State  Rewrite\n----- ------- ------------------------------- ------ -------\n0     0       LSD(A)                          InUse  Yes\n0     1       LSD(A)                          InUse  Yes\n0     2       LSD(A)                          InUse  Yes\n0     13      LSD(A)                          InUse  Yes\n0     24000   LDP(A)                          InUse  Yes\n0     24001   LDP(A)                          InUse  Yes\n0     24002   LDP(A)                          InUse  Yes\n0     24003   LDP(A)                          InUse  Yes\n0     24004   LDP(A)                          InUse  Yes\n0     24005   LDP(A)                          InUse  Yes\n0     24006   LDP(A)                          InUse  Yes\n0     24007   LDP(A)                          InUse  Yes\n0     24008   LDP(A)                          InUse  Yes\n0     24009   LDP(A)                          InUse  Yes\n0     24010   LDP(A)                          InUse  Yes\n0     24011   LDP(A)                          InUse  Yes\n0     24012   LDP(A)                          InUse  Yes\n0     24013   LDP(A)                          InUse  Yes\n0     24014   LDP(A)                          InUse  Yes\n0     24015   LDP(A)                          InUse  Yes\n0     24016   LDP(A)                          InUse  Yes\nRP/0/RP0/CPU0:PE1#\nRP/0/RP0/CPU0:PE1# show mpls forwarding\nWed Feb  1 05:45:45.895 UTC\nLocal  Outgoing    Prefix             Outgoing     Next Hop        Bytes\nLabel  Label       or ID              Interface                    Switched\n------ ----------- ------------------ ------------ --------------- ------------\n24000  Pop         2.2.2.2/32         Gi0/0/0/2    12.0.0.2        18522\n24001  24000       3.3.3.3/32         Gi0/0/0/2    12.0.0.2        0\n24002  24004       6.6.6.6/32         Gi0/0/0/2    12.0.0.2        0\n24003  24002       7.7.7.7/32         Gi0/0/0/2    12.0.0.2        0\n24004  24001       4.4.4.4/32         Gi0/0/0/2    12.0.0.2        0\n24005  24005       8.8.8.8/32         Gi0/0/0/2    12.0.0.2        0\n24006  24003       5.5.5.5/32         Gi0/0/0/2    12.0.0.2        0\n24007  Pop         23.0.0.0/24        Gi0/0/0/2    12.0.0.2        0\n24008  Pop         26.0.0.0/24        Gi0/0/0/2    12.0.0.2        793\n24009  24010       67.0.0.0/24        Gi0/0/0/2    12.0.0.2        0\n24010  24008       37.0.0.0/24        Gi0/0/0/2    12.0.0.2        0\n24011  Pop         27.0.0.0/24        Gi0/0/0/2    12.0.0.2        0\n24012  24007       47.0.0.0/24        Gi0/0/0/2    12.0.0.2        0\n24013  24006       34.0.0.0/24        Gi0/0/0/2    12.0.0.2        0\n24014  24011       78.0.0.0/24        Gi0/0/0/2    12.0.0.2        0\n24015  24012       48.0.0.0/24        Gi0/0/0/2    12.0.0.2        0\n24016  24009       45.0.0.0/24        Gi0/0/0/2    12.0.0.2        0\nRP/0/RP0/CPU0:PE1#\n</code></pre> CEF <pre><code>RP/0/RP0/CPU0:PE1#show cef 5.5.5.5/32\nWed Feb  1 05:46:41.858 UTC\n5.5.5.5/32, version 29, internal 0x1000001 0x30 (ptr 0xe7af578) [1], 0x600 (0xdacf608), 0xa28 (0xeae6968)\nUpdated Feb  1 02:58:34.731\nremote adjacency to GigabitEthernet0/0/0/2\nPrefix Len 32, traffic index 0, precedence n/a, priority 3\ngateway array (0xd937060) reference count 39, flags 0x68, source lsd (5), 1 backups\n[14 type 5 flags 0x8401 (0xeb294c8) ext 0x0 (0x0)]\nLW-LDI[type=5, refc=3, ptr=0xdacf608, sh-ldi=0xeb294c8]\ngateway array update type-time 1 Feb  1 02:58:34.731\nLDI Update time Feb  1 02:58:34.731\nLW-LDI-TS Feb  1 02:58:34.731\nvia 12.0.0.2/32, GigabitEthernet0/0/0/2, 4 dependencies, weight 0, class 0 [flags 0x0]\npath-idx 0 NHID 0x0 [0xf399790 0x0]\nnext hop 12.0.0.2/32\nremote adjacency\nlocal label 24006      labels imposed {24003}\nLoad distribution: 0 (refcount 14)\nHash  OK  Interface                 Address\n0     Y   GigabitEthernet0/0/0/2    remote\nRP/0/RP0/CPU0:PE1#\n</code></pre> Traceroute MPLS <pre><code>RP/0/RP0/CPU0:PE1#traceroute mpls ipv4 5.5.5.5/32\nWed Feb  1 05:47:07.839 UTC\nTracing MPLS Label Switched Path to 5.5.5.5/32, timeout is 2 seconds\nCodes: '!' - success, 'Q' - request not sent, '.' - timeout,\n'L' - labeled output interface, 'B' - unlabeled output interface,\n'D' - DS Map mismatch, 'F' - no FEC mapping, 'f' - FEC mismatch,\n'M' - malformed request, 'm' - unsupported tlvs, 'N' - no rx label,\n'P' - no rx intf label prot, 'p' - premature termination of LSP,\n'R' - transit router, 'I' - unknown upstream index,\n'X' - unknown return code, 'x' - return code 0\nType escape sequence to abort.\n0 12.0.0.1 MRU 1500 [Labels: 24003 Exp: 0]\nL 1 12.0.0.2 MRU 1500 [Labels: 24005 Exp: 0] 23 ms\nL 2 27.0.0.7 MRU 1500 [Labels: 24000 Exp: 0] 11 ms\nL 3 47.0.0.4 MRU 1500 [Labels: implicit-null Exp: 0] 12 ms\n! 4 45.0.0.5 13 ms\nRP/0/RP0/CPU0:PE1#\nRP/0/RP0/CPU0:PE1#show mpls forwarding prefix 5.5.5.5/32\nWed Feb  1 05:47:16.264 UTC\nLocal  Outgoing    Prefix             Outgoing     Next Hop        Bytes\nLabel  Label       or ID              Interface                    Switched\n------ ----------- ------------------ ------------ --------------- ------------\n24006  24003       5.5.5.5/32         Gi0/0/0/2    12.0.0.2        0\nRP/0/RP0/CPU0:PE1#\nRP/0/RP0/CPU0:P2#show mpls forwarding prefix 5.5.5.5/32\nWed Feb  1 05:47:29.351 UTC\nLocal  Outgoing    Prefix             Outgoing     Next Hop        Bytes\nLabel  Label       or ID              Interface                    Switched\n------ ----------- ------------------ ------------ --------------- ------------\n24003  24002       5.5.5.5/32         Gi0/0/0/0    23.0.0.3        768\n24005       5.5.5.5/32         Gi0/0/0/3    27.0.0.7        1488\nRP/0/RP0/CPU0:P2#\nRP/0/RP0/CPU0:P7#show mpls forwarding prefix 5.5.5.5/32\nWed Feb  1 05:47:45.797 UTC\nLocal  Outgoing    Prefix             Outgoing     Next Hop        Bytes\nLabel  Label       or ID              Interface                    Switched\n------ ----------- ------------------ ------------ --------------- ------------\n24005  24000       5.5.5.5/32         Gi0/0/0/4    47.0.0.4        992\nRP/0/RP0/CPU0:P7#\nRP/0/RP0/CPU0:P4#show mpls forwarding prefix 5.5.5.5/32\nWed Feb  1 05:47:53.011 UTC\nLocal  Outgoing    Prefix             Outgoing     Next Hop        Bytes\nLabel  Label       or ID              Interface                    Switched\n------ ----------- ------------------ ------------ --------------- ------------\n24000  Pop         5.5.5.5/32         Gi0/0/0/0    45.0.0.5        20190\nRP/0/RP0/CPU0:P4#\n</code></pre> <p>Traceroute MPLS Multipath</p> <p>Multipath traceroute for reference, since there are equal cost multiple paths available.</p> Traceroute MPLS Multipath <pre><code>RP/0/RP0/CPU0:PE1#traceroute mpls multipath ipv4 5.5.5.5/32 verbose\nWed Feb  1 05:52:20.770 UTC\nStarting LSP Path Discovery for 5.5.5.5/32\nCodes: '!' - success, 'Q' - request not sent, '.' - timeout,\n'L' - labeled output interface, 'B' - unlabeled output interface,\n'D' - DS Map mismatch, 'F' - no FEC mapping, 'f' - FEC mismatch,\n'M' - malformed request, 'm' - unsupported tlvs, 'N' - no rx label,\n'P' - no rx intf label prot, 'p' - premature termination of LSP,\n'R' - transit router, 'I' - unknown upstream index,\n'X' - unknown return code, 'x' - return code 0\nType escape sequence to abort.\nLLL!\nPath 0 found,\noutput interface GigabitEthernet0/0/0/2 nexthop 12.0.0.2\nsource 12.0.0.1 destination 127.0.0.3\n0 12.0.0.1 12.0.0.2 MRU 1500 [Labels: 24003 Exp: 0] multipaths 0\nL 1 12.0.0.2 23.0.0.3 MRU 1500 [Labels: 24002 Exp: 0] ret code 8 multipaths 2\nL 2 23.0.0.3 34.0.0.4 MRU 1500 [Labels: 24000 Exp: 0] ret code 8 multipaths 1\nL 3 34.0.0.4 45.0.0.5 MRU 1500 [Labels: implicit-null Exp: 0] ret code 8 multipaths 1\n! 4 45.0.0.5, ret code 3 multipaths 0\nLL!\nPath 1 found,\noutput interface GigabitEthernet0/0/0/2 nexthop 12.0.0.2\nsource 12.0.0.1 destination 127.0.0.0\n0 12.0.0.1 12.0.0.2 MRU 1500 [Labels: 24003 Exp: 0] multipaths 0\nL 1 12.0.0.2 27.0.0.7 MRU 1500 [Labels: 24005 Exp: 0] ret code 8 multipaths 2\nL 2 27.0.0.7 47.0.0.4 MRU 1500 [Labels: 24000 Exp: 0] ret code 8 multipaths 1\nL 3 47.0.0.4 45.0.0.5 MRU 1500 [Labels: implicit-null Exp: 0] ret code 8 multipaths 1\n! 4 45.0.0.5, ret code 3 multipaths 0\nPaths (found/broken/unexplored) (2/0/0)\nEcho Request (sent/fail) (7/0)\nEcho Reply (received/timeout) (7/0)\nTotal Time Elapsed 96 ms\nRP/0/RP0/CPU0:PE1#\n</code></pre>"},{"location":"micro_loop_avoidance/","title":"Microloop Avoidance","text":"Microloop Avoidance <p>Micro loops induce brief packet loss in the network during convergence; they can occur during both a link up and a link down event and result in packet loss.</p> <p>In a FRR-enabled network, avoiding micro loops is desirable; enable micro loop avoidance on P2 for segment routing.</p> <p>Microloop avoidance is locally significant to the router.</p>"},{"location":"micro_loop_avoidance/#prepare-the-topology","title":"Prepare the topology","text":"<p>Continuing with the previous topology, we disable the isis adjacency between P8 and P4 and raise the metric between P2 and P-RR3 to 100.</p> P2P8 <pre><code>router isis IGP\ninterface GigabitEthernet0/0/0/0\naddress-family ipv4 unicast\nmetric 100\n</code></pre> <pre><code>router isis IGP\ninterface GigabitEthernet0/0/0/1\nshutdown\n</code></pre>"},{"location":"micro_loop_avoidance/#verify","title":"Verify","text":"<p>There is no other path to get to PE5 but through P3, which likewise applies to P6, P7, and P8.</p> <pre><code>RP/0/RP0/CPU0:P2#show isis fast-reroute 5.5.5.5/32 detail\nWed Feb  1 07:47:01.246 UTC\nL2 5.5.5.5/32 [120/115] Label: 16005, medium priority\nInstalled Feb 01 07:46:48.159 for 00:00:13\nvia 23.0.0.3, GigabitEthernet0/0/0/0, Label: 16005, P3, SRGB Base: 16000, Weight: 0\nNo FRR backup\nsrc PE5.00-00, 5.5.5.5, prefix-SID index 5, R:0 N:1 P:0 E:0 V:0 L:0, Alg:0\nRP/0/RP0/CPU0:P2#\nRP/0/RP0/CPU0:P2#show route 5.5.5.5/32\nWed Feb  1 07:47:10.957 UTC\nRouting entry for 5.5.5.5/32\nKnown via \"isis IGP\", distance 115, metric 120, labeled SR, type level-2\nInstalled Feb  1 07:46:48.159 for 00:00:22\nRouting Descriptor Blocks\n23.0.0.3, from 5.5.5.5, via GigabitEthernet0/0/0/0\nRoute metric is 120\nNo advertising protos.\nRP/0/RP0/CPU0:P2#\nRP/0/RP0/CPU0:P2#show cef 5.5.5.5/32\nWed Feb  1 07:47:14.307 UTC\n5.5.5.5/32, version 562, labeled SR, internal 0x1000001 0x8310 (ptr 0xe727de0) [1], 0x600 (0xe190578), 0xa28 (0xeb30828)\nUpdated Feb  1 07:46:48.167\nremote adjacency to GigabitEthernet0/0/0/0\nPrefix Len 32, traffic index 0, precedence n/a, priority 1\ngateway array (0xdff9e48) reference count 6, flags 0x68, source rib (7), 1 backups\n[3 type 5 flags 0x8401 (0xeb743c8) ext 0x0 (0x0)]\nLW-LDI[type=5, refc=3, ptr=0xe190578, sh-ldi=0xeb743c8]\ngateway array update type-time 1 Feb  1 07:46:48.167\nLDI Update time Feb  1 07:46:48.167\nLW-LDI-TS Feb  1 07:46:48.167\nvia 23.0.0.3/32, GigabitEthernet0/0/0/0, 8 dependencies, weight 0, class 0 [flags 0x0]\npath-idx 0 NHID 0x0 [0xf399a10 0x0]\nnext hop 23.0.0.3/32\nremote adjacency\nlocal label 16005      labels imposed {16005}\nLoad distribution: 0 (refcount 3)\nHash  OK  Interface                 Address\n0     Y   GigabitEthernet0/0/0/0    remote\nRP/0/RP0/CPU0:P2#\n</code></pre>"},{"location":"micro_loop_avoidance/#enable-microloop-avoidance-on-p2","title":"Enable Microloop Avoidance on P2","text":"<p>Configure a rib-update-delay of 60 seconds (max) to see the microloop avoidance in operation before the ISIS convergence.</p> Configure Microloop Avoidance on P2 <pre><code>router isis IGP\naddress-family ipv4 unicast\nmicroloop avoidance segment-routing\nmicroloop avoidance rib-update-delay 60000\n</code></pre>"},{"location":"micro_loop_avoidance/#in-action-microloop-avoidance","title":"In Action: Microloop Avoidance","text":"<p>It's time to bring up the adjacency between P8 and P4 and check how microloop avoidance works.</p> P8 <pre><code>router isis IGP\ninterface GigabitEthernet0/0/0/1\nno shutdown\n</code></pre> <p>P2 launches an explicit designated path to tunnel traffic via P8 and prevent microloops along the core path for a limited period of time (60 seconds in our arrangement).</p> <p>Microloop Avoidance Tunnel</p> <p>The explicit path launched by the microloop avoidance mechanism, in contrast to the TI-LFA examples, is for the primary path, not the backup path. Until the IGP convergence is complete, the explicit path exists.</p> P2 <pre><code>RP/0/RP0/CPU0:P2#show isis protocol | utility egrep -A2 Micro\nWed Feb  1 07:59:57.510 UTC\nMicroloop avoidance: Enabled\nConfiguration: Type: Segment routing, RIB update delay: 60000 msec\nNo protocols redistributed\nRP/0/RP0/CPU0:P2#\nRP/0/RP0/CPU0:P2#show isis protocol | utility egrep -A2 Micro\nWed Feb  1 08:00:07.477 UTC\nMicroloop avoidance: Enabled\nConfiguration: Type: Segment routing, RIB update delay: 60000 msec\nState: Active, Duration: 2721 ms, Event Link up, Near: P8.00 Far: P4.00  // (1)\nRP/0/RP0/CPU0:P2#\nRP/0/RP0/CPU0:P2#show isis fast-reroute 5.5.5.5/32 detail\nWed Feb  1 08:00:18.127 UTC\nL2 5.5.5.5/32 [50/115] Label: 16005, medium priority\nInstalled Feb 01 08:00:04.866 for 00:00:14\nvia 26.0.0.6, GigabitEthernet0/0/0/1, P6, SRGB Base: 16000, Weight: 0\nNo FRR backup\nexp 26.0.0.6, GigabitEthernet0/0/0/1, P6, SRGB Base: 16000, Weight: 0  // (2)\nvia explicit path\nP node: P8.00 [8.8.8.8], Label: 16008\nQ node: P4.00 [4.4.4.4], Label: 24017\nPrefix label: 16005\nsrc PE5.00-00, 5.5.5.5, prefix-SID index 5, R:0 N:1 P:0 E:0 V:0 L:0, Alg:0\nRP/0/RP0/CPU0:P2#\nRP/0/RP0/CPU0:P2#show route 5.5.5.5/32\nWed Feb  1 08:00:24.310 UTC\nRouting entry for 5.5.5.5/32\nKnown via \"isis IGP\", distance 115, metric 50, labeled SR, type level-2\nInstalled Feb  1 08:00:04.867 for 00:00:19\nRouting Descriptor Blocks\n26.0.0.6, from 5.5.5.5, via GigabitEthernet0/0/0/1\nRoute metric is 50\nNo advertising protos.\nRP/0/RP0/CPU0:P2#\nRP/0/RP0/CPU0:P2#show route 5.5.5.5/32 detail\nWed Feb  1 08:00:28.633 UTC\nRouting entry for 5.5.5.5/32\nKnown via \"isis IGP\", distance 115, metric 50, labeled SR, type level-2\nInstalled Feb  1 08:00:04.867 for 00:00:23\nRouting Descriptor Blocks\n26.0.0.6, from 5.5.5.5, via GigabitEthernet0/0/0/1\nRoute metric is 50\nLabels: 0x3e88 0x5dd1 0x3e85 (16008 24017 16005)  // (3)\nTunnel ID: None\nBinding Label: None\nExtended communities count: 0\nPath id:1       Path ref count:0\nNHID:0x2(Ref:15)\nRoute version is 0x57 (87)\nLocal Label: 0x3e85 (16005)\nIP Precedence: Not Set\nQoS Group ID: Not Set\nFlow-tag: Not Set\nFwd-class: Not Set\nRoute Priority: RIB_PRIORITY_NON_RECURSIVE_MEDIUM (7) SVD Type RIB_SVD_TYPE_LOCAL\nDownload Priority 1, Download Version 848\nNo advertising protos.\nRP/0/RP0/CPU0:P2#\nRP/0/RP0/CPU0:P2#show cef 5.5.5.5/32\nWed Feb  1 08:00:34.545 UTC\n5.5.5.5/32, version 848, labeled SR, internal 0x1000001 0x8310 (ptr 0xe727de0) [1], 0x600 (0xe190578), 0xa28 (0xeb30dc8)\nUpdated Feb  1 08:00:04.882\nremote adjacency to GigabitEthernet0/0/0/1\nPrefix Len 32, traffic index 0, precedence n/a, priority 1\ngateway array (0xdff9708) reference count 15, flags 0x68, source rib (7), 1 backups\n[6 type 5 flags 0x8401 (0xeb738e8) ext 0x0 (0x0)]\nLW-LDI[type=5, refc=3, ptr=0xe190578, sh-ldi=0xeb738e8]\ngateway array update type-time 1 Feb  1 07:58:24.077\nLDI Update time Feb  1 07:58:24.079\nLW-LDI-TS Feb  1 08:00:04.882\nvia 26.0.0.6/32, GigabitEthernet0/0/0/1, 10 dependencies, weight 0, class 0 [flags 0x0]\npath-idx 0 NHID 0x0 [0xf399970 0x0]\nnext hop 26.0.0.6/32\nremote adjacency\nlocal label 16005      labels imposed {16008 24017 16005}  // (4)\nLoad distribution: 0 (refcount 6)\nHash  OK  Interface                 Address\n0     Y   GigabitEthernet0/0/0/1    remote\nRP/0/RP0/CPU0:P2#\n</code></pre> <ol> <li>P8 interface turned up, and Microloop Avoidance was triggered on P2, since hops along the route to P8 may loop it.</li> <li>Until the rib-update delay duration ends, the principal traffic is tunnelled through P8 and P4.</li> <li>The principal traffic is tunnelled explicitly through P8.</li> <li>Identical to explicit route table tunnel. </li> </ol>"},{"location":"micro_loop_avoidance/#restore-the-original-topology","title":"Restore the original topology","text":"P2P7 <pre><code>router isis IGP\ninterface GigabitEthernet0/0/0/0\naddress-family ipv4 unicast\nmetric 10\n</code></pre> <pre><code>router isis IGP\ninterface GigabitEthernet0/0/0/1\nno shutdown\n!\ninterface GigabitEthernet0/0/0/3\nno shutdown\n!\ninterface GigabitEthernet0/0/0/4\nno shutdown\n</code></pre>"},{"location":"mpls_traffic_eng/","title":"MPLS Traffic-Engineering","text":"<p>One of the labs in the following sections requires the routers to be configured for mpls traffic engineering.</p> <p>The label stack may hold a maximum of three labels, as seen in the double segment ti-lfa lab.</p> <p>When the number of labels necessary to restore a backup tunnel grows, the Cisco IOS XR platform initiates an auto-tunnel and uses the tunnel interface as the next-hop.</p> All Routers <pre><code>ipv4 unnumbered mpls traffic-eng Loopback0\nrouter isis IGP address-family ipv4 unicast mpls traffic-eng router-id Loopback0\nmpls traffic-eng\n</code></pre>"},{"location":"sr_intro/","title":"Introducing Segment Routing (SR)","text":"Segment Routing + LDP"},{"location":"sr_intro/#configuration","title":"Configuration","text":"<p>Configure SR on the routers on the topology's left side.</p> <ol> <li>Each node will be assigned a unique prefix-sid x, where x is the node number, and this will be specified on its loopback interface.<ol> <li>PE1: 1, P2: 2, etc.</li> </ol> </li> <li>When the Prefix-SID index is appended to the SRGB lowest offset value 16000, the result is a Prefix-SID label.</li> <li>Enable SR exclusively on the control plane; routers will continue to use LDP labels to direct traffic in the data plane.</li> </ol> PE1P2P3P6P7 <pre><code>router isis IGP\naddress-family ipv4 unicast\nsegment-routing mpls\n!\ninterface Loopback0\naddress-family ipv4 unicast\nprefix-sid index 1\n</code></pre> <pre><code>router isis IGP\naddress-family ipv4 unicast\nsegment-routing mpls\n!\ninterface Loopback0\naddress-family ipv4 unicast\nprefix-sid index 2\n</code></pre> <pre><code>router isis IGP\naddress-family ipv4 unicast\nsegment-routing mpls\n!\ninterface Loopback0\naddress-family ipv4 unicast\nprefix-sid index 3\n</code></pre> <pre><code>router isis IGP\naddress-family ipv4 unicast\nsegment-routing mpls\n!\ninterface Loopback0\naddress-family ipv4 unicast\nprefix-sid index 6\n</code></pre> <pre><code>router isis IGP\naddress-family ipv4 unicast\nsegment-routing mpls\n!\ninterface Loopback0\naddress-family ipv4 unicast\nprefix-sid index 7\n</code></pre>"},{"location":"sr_intro/#verify","title":"Verify","text":"<p>In Cisco XR, the default SRGB (Segment Routing Global Block) is 16000 - 23999, which means 8000 labels are allocated for Prefix SID (Segment ID). The router assigns Adjacency-SID from the label switch database's dynamic range, starting at 24000.</p> <p>For each adjacency, Cisco XR creates two Adj-SIDs, one protected and one not.</p> SR Labels <pre><code>RP/0/RP0/CPU0:PE1#show mpls label table detail\nWed Feb  1 06:01:51.053 UTC\nTable Label   Owner                           State  Rewrite\n----- ------- ------------------------------- ------ -------\n0     0       LSD(A)                          InUse  Yes\n0     1       LSD(A)                          InUse  Yes\n0     2       LSD(A)                          InUse  Yes\n0     13      LSD(A)                          InUse  Yes\n0     16000   ISIS(A):IGP                     InUse  No\n(Lbl-blk SRGB, vers:0, (start_label=16000, size=8000)\n0     24000   LDP(A)                          InUse  Yes\n(IPv4, vers:0, 'default':4U, 2.2.2.2/32)\n0     24001   LDP(A)                          InUse  Yes\n(IPv4, vers:0, 'default':4U, 3.3.3.3/32)\n0     24002   LDP(A)                          InUse  Yes\n(IPv4, vers:0, 'default':4U, 6.6.6.6/32)\n0     24003   LDP(A)                          InUse  Yes\n(IPv4, vers:0, 'default':4U, 7.7.7.7/32)\n0     24004   LDP(A)                          InUse  Yes\n(IPv4, vers:0, 'default':4U, 4.4.4.4/32)\n0     24005   LDP(A)                          InUse  Yes\n(IPv4, vers:0, 'default':4U, 8.8.8.8/32)\n0     24006   LDP(A)                          InUse  Yes\n(IPv4, vers:0, 'default':4U, 5.5.5.5/32)\n0     24007   LDP(A)                          InUse  Yes\n(IPv4, vers:0, 'default':4U, 23.0.0.0/24)\n0     24008   LDP(A)                          InUse  Yes\n(IPv4, vers:0, 'default':4U, 26.0.0.0/24)\n0     24009   LDP(A)                          InUse  Yes\n(IPv4, vers:0, 'default':4U, 67.0.0.0/24)\n0     24010   LDP(A)                          InUse  Yes\n(IPv4, vers:0, 'default':4U, 37.0.0.0/24)\n0     24011   LDP(A)                          InUse  Yes\n(IPv4, vers:0, 'default':4U, 27.0.0.0/24)\n0     24012   LDP(A)                          InUse  Yes\n(IPv4, vers:0, 'default':4U, 47.0.0.0/24)\n0     24013   LDP(A)                          InUse  Yes\n(IPv4, vers:0, 'default':4U, 34.0.0.0/24)\n0     24014   LDP(A)                          InUse  Yes\n(IPv4, vers:0, 'default':4U, 78.0.0.0/24)\n0     24015   LDP(A)                          InUse  Yes\n(IPv4, vers:0, 'default':4U, 48.0.0.0/24)\n0     24016   LDP(A)                          InUse  Yes\n(IPv4, vers:0, 'default':4U, 45.0.0.0/24)\n0     24017   ISIS(A):IGP                     InUse  Yes\n(SR Adj Segment IPv4, vers:0, index=1, type=0, intf=Gi0/0/0/2, nh=12.0.0.2)\n0     24018   ISIS(A):IGP                     InUse  Yes\n(SR Adj Segment IPv4, vers:0, index=3, type=0, intf=Gi0/0/0/2, nh=12.0.0.2)\nRP/0/RP0/CPU0:PE1#\nRP/0/RP0/CPU0:PE1#show isis adjacency detail\nWed Feb  1 06:01:53.577 UTC\nIS-IS IGP Level-2 adjacencies:\nSystem Id      Interface                SNPA           State Hold Changed  NSF IPv4 IPv6\nBFD  BFD\nP2             Gi0/0/0/2                *PtoP*         Up    22   03:03:32 Yes None None\nArea Address:           49\nNeighbor IPv4 Address:  12.0.0.2*\nAdjacency SID:          24017\nNon-FRR Adjacency SID:  24018\nTopology:               IPv4 Unicast\nBFD Status:             BFD Not Required, Neighbor Useable\nTotal adjacency count: 1\nRP/0/RP0/CPU0:PE1#\n</code></pre> ISIS Database <p>ISIS has been extended to propagate Segment Routing information to all routers in the topology, such as SRGB (Segment Routing Global Block), Prefix-SID, and Adj-SID.</p> <pre><code>RP/0/RP0/CPU0:PE1#show isis database verbose PE1\nWed Feb  1 06:03:12.922 UTC\nIS-IS IGP (Level-2) Link State Database\nLSPID                 LSP Seq Num  LSP Checksum  LSP Holdtime/Rcvd  ATT/P/OL\nPE1.00-00           * 0x00000016   0x76da        978  /*            0/0/0\nArea Address:   49\nNLPID:          0xcc\nIP Address:     1.1.1.1\nMetric: 10         IP-Extended 12.0.0.0/24\nPrefix Attribute Flags: X:0 R:0 N:0 E:0 A:0\nMetric: 0          IP-Extended 1.1.1.1/32\nPrefix-SID Index: 1, Algorithm:0, R:0 N:1 P:0 E:0 V:0 L:0\nPrefix Attribute Flags: X:0 R:0 N:1 E:0 A:0\nHostname:       PE1\nRouter Cap:     1.1.1.1 D:0 S:0\nSegment Routing: I:1 V:0, SRGB Base: 16000 Range: 8000\nNode Maximum SID Depth:\nLabel Imposition: 10\nSR Algorithm:\nAlgorithm: 0\nAlgorithm: 1\nMetric: 10         IS-Extended P2.00\nLocal Interface ID: 9, Remote Interface ID: 9\nInterface IP Address: 12.0.0.1\nNeighbor IP Address: 12.0.0.2\nPhysical BW: 1000000 kbits/sec\nADJ-SID: F:0 B:0 V:1 L:1 S:0 P:0 weight:0 Adjacency-sid:24018\nTotal Level-2 LSP count: 1     Local Level-2 LSP count: 1\nRP/0/RP0/CPU0:PE1#\n</code></pre> Prefix SID Table <pre><code>RP/0/RP0/CPU0:PE1#show isis segment-routing label table\nWed Feb  1 06:04:30.395 UTC\nIS-IS IGP IS Label Table\nLabel         Prefix                   Interface\n----------    ----------------         ---------\n16001         1.1.1.1/32               Loopback0\n16002         2.2.2.2/32\n16003         3.3.3.3/32\n16006         6.6.6.6/32\n16007         7.7.7.7/32\nRP/0/RP0/CPU0:PE1#\n</code></pre> Routing Table <pre><code>RP/0/RP0/CPU0:PE1#show route 7.7.7.7/32 detail\nWed Feb  1 06:05:31.910 UTC\nRouting entry for 7.7.7.7/32\nKnown via \"isis IGP\", distance 115, metric 20, labeled SR, type level-2 // (1)\nInstalled Feb  1 06:00:31.849 for 00:05:00\nRouting Descriptor Blocks\n12.0.0.2, from 7.7.7.7, via GigabitEthernet0/0/0/2\nRoute metric is 20\nLabel: 0x3e87 (16007) // (2)\nTunnel ID: None\nBinding Label: None\nExtended communities count: 0\nPath id:1       Path ref count:0\nNHID:0x1(Ref:18)\nRoute version is 0x8 (8)\nLocal Label: 0x3e87 (16007)\nIP Precedence: Not Set\nQoS Group ID: Not Set\nFlow-tag: Not Set\nFwd-class: Not Set\nRoute Priority: RIB_PRIORITY_NON_RECURSIVE_MEDIUM (7) SVD Type RIB_SVD_TYPE_LOCAL\nDownload Priority 1, Download Version 109\nNo advertising protos.\nRP/0/RP0/CPU0:PE1#\n</code></pre> <ol> <li>This is now a <code>labeled SR</code> route</li> <li>Segment Routing Prefix-SID label, also called Node-SID</li> </ol> MPLS Forwarding Table <p>Despite the fact that both prefix-sid and adjacency-sid labels are propagated in ISIS, routers only install the prefix-sid labels of all routers in the topology and just the locally generated adjacency-sid labels.</p> <pre><code>RP/0/RP0/CPU0:P2#show mpls forwarding\nWed Feb  1 06:06:02.160 UTC\nLocal  Outgoing    Prefix             Outgoing     Next Hop        Bytes\nLabel  Label       or ID              Interface                    Switched\n------ ----------- ------------------ ------------ --------------- ------------\n16001  Pop         SR Pfx (idx 1)     Gi0/0/0/2    12.0.0.1        0\n16003  Pop         SR Pfx (idx 3)     Gi0/0/0/0    23.0.0.3        0\n16006  Pop         SR Pfx (idx 6)     Gi0/0/0/1    26.0.0.6        0\n16007  Pop         SR Pfx (idx 7)     Gi0/0/0/3    27.0.0.7        0\n24000  Pop         3.3.3.3/32         Gi0/0/0/0    23.0.0.3        646\n24001  24000       4.4.4.4/32         Gi0/0/0/0    23.0.0.3        0\n24004       4.4.4.4/32         Gi0/0/0/3    27.0.0.7        0\n24002  Pop         7.7.7.7/32         Gi0/0/0/3    27.0.0.7        588\n24003  24002       5.5.5.5/32         Gi0/0/0/0    23.0.0.3        1152\n24005       5.5.5.5/32         Gi0/0/0/3    27.0.0.7        1872\n24004  Pop         6.6.6.6/32         Gi0/0/0/1    26.0.0.6        686\n24005  24000       8.8.8.8/32         Gi0/0/0/3    27.0.0.7        0\n24006  Pop         34.0.0.0/24        Gi0/0/0/0    23.0.0.3        0\n24007  Pop         47.0.0.0/24        Gi0/0/0/3    27.0.0.7        0\n24008  Pop         37.0.0.0/24        Gi0/0/0/0    23.0.0.3        776\nPop         37.0.0.0/24        Gi0/0/0/3    27.0.0.7        0\n24009  24007       45.0.0.0/24        Gi0/0/0/0    23.0.0.3        0\n24007       45.0.0.0/24        Gi0/0/0/3    27.0.0.7        0\n24010  Pop         67.0.0.0/24        Gi0/0/0/3    27.0.0.7        776\nPop         67.0.0.0/24        Gi0/0/0/1    26.0.0.6        776\n24011  Pop         78.0.0.0/24        Gi0/0/0/3    27.0.0.7        0\n24012  24011       48.0.0.0/24        Gi0/0/0/0    23.0.0.3        0\n24001       48.0.0.0/24        Gi0/0/0/3    27.0.0.7        0\n24013  Pop         1.1.1.1/32         Gi0/0/0/2    12.0.0.1        686\n24014  Pop         SR Adj (idx 1)     Gi0/0/0/2    12.0.0.1        0\n24015  Pop         SR Adj (idx 3)     Gi0/0/0/2    12.0.0.1        0\n24016  Pop         SR Adj (idx 1)     Gi0/0/0/0    23.0.0.3        0\n24017  Pop         SR Adj (idx 3)     Gi0/0/0/0    23.0.0.3        0\n24018  Pop         SR Adj (idx 1)     Gi0/0/0/1    26.0.0.6        0\n24019  Pop         SR Adj (idx 3)     Gi0/0/0/1    26.0.0.6        0\n24020  Pop         SR Adj (idx 1)     Gi0/0/0/3    27.0.0.7        0\n24021  Pop         SR Adj (idx 3)     Gi0/0/0/3    27.0.0.7        0\nRP/0/RP0/CPU0:P2#\n</code></pre> CEF <pre><code>RP/0/RP0/CPU0:PE1#show cef 7.7.7.7/32\nWed Feb  1 06:07:19.682 UTC\n7.7.7.7/32, version 79, labeled SR, internal 0x1000001 0x8130 (ptr 0xe7af800) [1], 0x600 (0xdacf5c0), 0xa28 (0xeae69b8)\nUpdated Feb  1 06:00:31.856\nremote adjacency to GigabitEthernet0/0/0/2\nPrefix Len 32, traffic index 0, precedence n/a, priority 3\nExtensions: context-label:16007\ngateway array (0xd937230) reference count 9, flags 0x68, source lsd (5), 1 backups\n[4 type 5 flags 0x8401 (0xeb29708) ext 0x0 (0x0)]\nLW-LDI[type=5, refc=3, ptr=0xdacf5c0, sh-ldi=0xeb29708]\ngateway array update type-time 1 Feb  1 06:00:05.844\nLDI Update time Feb  1 06:00:05.844\nLW-LDI-TS Feb  1 06:00:31.858\nvia 12.0.0.2/32, GigabitEthernet0/0/0/2, 14 dependencies, weight 0, class 0 [flags 0x0]\npath-idx 0 NHID 0x0 [0xf399790 0x0]\nnext hop 12.0.0.2/32\nremote adjacency\nlocal label 24003      labels imposed {24002} // (1)\nLoad distribution: 0 (refcount 4)\nHash  OK  Interface                 Address\n0     Y   GigabitEthernet0/0/0/2    remote\nRP/0/RP0/CPU0:PE1#\n</code></pre> <ol> <li>LDP Labels</li> </ol> Traceroute MPLS <p>MPLS Data Plane</p> <p>Although a labelled SR route is available, the mpls data plane continues to use LDP by default.</p> <pre><code>RP/0/RP0/CPU0:PE1#traceroute mpls ipv4 7.7.7.7/32\nWed Feb  1 06:07:59.433 UTC\nTracing MPLS Label Switched Path to 7.7.7.7/32, timeout is 2 seconds\nCodes: '!' - success, 'Q' - request not sent, '.' - timeout,\n'L' - labeled output interface, 'B' - unlabeled output interface,\n'D' - DS Map mismatch, 'F' - no FEC mapping, 'f' - FEC mismatch,\n'M' - malformed request, 'm' - unsupported tlvs, 'N' - no rx label,\n'P' - no rx intf label prot, 'p' - premature termination of LSP,\n'R' - transit router, 'I' - unknown upstream index,\n'X' - unknown return code, 'x' - return code 0\nType escape sequence to abort.\n0 12.0.0.1 MRU 1500 [Labels: 24002 Exp: 0]\nL 1 12.0.0.2 MRU 1500 [Labels: implicit-null Exp: 0] 23 ms\n! 2 27.0.0.7 18 ms\nRP/0/RP0/CPU0:PE1#\n</code></pre> Traceroute SR-MPLS <p>SR-MPLS Data Plane</p> <p>There is also an SR-MPLS data plane that may be tested, as seen below.</p> <pre><code>RP/0/RP0/CPU0:PE1#traceroute sr-mpls 7.7.7.7/32\nWed Feb  1 06:08:16.413 UTC\nTracing MPLS Label Switched Path to 7.7.7.7/32, timeout is 2 seconds\nCodes: '!' - success, 'Q' - request not sent, '.' - timeout,\n'L' - labeled output interface, 'B' - unlabeled output interface,\n'D' - DS Map mismatch, 'F' - no FEC mapping, 'f' - FEC mismatch,\n'M' - malformed request, 'm' - unsupported tlvs, 'N' - no rx label,\n'P' - no rx intf label prot, 'p' - premature termination of LSP,\n'R' - transit router, 'I' - unknown upstream index,\n'X' - unknown return code, 'x' - return code 0\nType escape sequence to abort.\n0 12.0.0.1 MRU 1500 [Labels: 16007 Exp: 0]\nL 1 12.0.0.2 MRU 1500 [Labels: implicit-null Exp: 0] 11 ms\n! 2 27.0.0.7 18 ms\nRP/0/RP0/CPU0:PE1#\n</code></pre>"},{"location":"sr_intro/#sr-data-plane","title":"SR Data Plane","text":"<p>When segment routing is enabled in ISIS, the sr-prefer keyword is required for the CEF table to prefer SR-MPLS labels over LDP labels.</p> PE1P2P3P6P7 <pre><code>router isis IGP\naddress-family ipv4 unicast\nsegment-routing mpls sr-prefer\n</code></pre> <pre><code>router isis IGP\naddress-family ipv4 unicast\nsegment-routing mpls sr-prefer\n</code></pre> <pre><code>router isis IGP\naddress-family ipv4 unicast\nsegment-routing mpls sr-prefer\n</code></pre> <pre><code>router isis IGP\naddress-family ipv4 unicast\nsegment-routing mpls sr-prefer\n</code></pre> <pre><code>router isis IGP\naddress-family ipv4 unicast\nsegment-routing mpls sr-prefer\n</code></pre>"},{"location":"sr_intro/#verify_1","title":"Verify","text":"MPLS Data Plane <p>The SR enabled nodes may be accessible using both SR and LDP, however SR is now the default protocol in the mpls data plane.</p> <pre><code>RP/0/RP0/CPU0:PE1#traceroute mpls ipv4 7.7.7.7/32\nWed Feb  1 06:10:42.008 UTC\nTracing MPLS Label Switched Path to 7.7.7.7/32, timeout is 2 seconds\nCodes: '!' - success, 'Q' - request not sent, '.' - timeout,\n'L' - labeled output interface, 'B' - unlabeled output interface,\n'D' - DS Map mismatch, 'F' - no FEC mapping, 'f' - FEC mismatch,\n'M' - malformed request, 'm' - unsupported tlvs, 'N' - no rx label,\n'P' - no rx intf label prot, 'p' - premature termination of LSP,\n'R' - transit router, 'I' - unknown upstream index,\n'X' - unknown return code, 'x' - return code 0\nType escape sequence to abort.\n0 12.0.0.1 MRU 1500 [Labels: 16007 Exp: 0]\nL 1 12.0.0.2 MRU 1500 [Labels: implicit-null Exp: 0] 19 ms\n! 2 27.0.0.7 11 ms\nRP/0/RP0/CPU0:PE1#\n</code></pre> <p>In the mpls data plane, the other routers that can only be accessible via LDP are doing the same.</p> <pre><code>RP/0/RP0/CPU0:PE1#traceroute mpls ipv4 5.5.5.5/32\nWed Feb  1 06:10:58.359 UTC\nTracing MPLS Label Switched Path to 5.5.5.5/32, timeout is 2 seconds\nCodes: '!' - success, 'Q' - request not sent, '.' - timeout,\n'L' - labeled output interface, 'B' - unlabeled output interface,\n'D' - DS Map mismatch, 'F' - no FEC mapping, 'f' - FEC mismatch,\n'M' - malformed request, 'm' - unsupported tlvs, 'N' - no rx label,\n'P' - no rx intf label prot, 'p' - premature termination of LSP,\n'R' - transit router, 'I' - unknown upstream index,\n'X' - unknown return code, 'x' - return code 0\nType escape sequence to abort.\n0 12.0.0.1 MRU 1500 [Labels: 24003 Exp: 0]\nL 1 12.0.0.2 MRU 1500 [Labels: 24005 Exp: 0] 11 ms\nL 2 27.0.0.7 MRU 1500 [Labels: 24000 Exp: 0] 10 ms\nL 3 47.0.0.4 MRU 1500 [Labels: implicit-null Exp: 0] 13 ms\n! 4 45.0.0.5 15 ms\nRP/0/RP0/CPU0:PE1#\n</code></pre>"},{"location":"sr_ldp_inter/","title":"SR - LDP Interworking","text":"SR - LDP Interworking <p>As we've shown in earlier sections, SR and LDP can coexist. With sr-prefer enabled, if an SR labelled path exists, use it; otherwise, use an LDP labelled path for a specific destination.</p> <p>The next step is to transition traffic between SR-only and LDP-only domains.</p>"},{"location":"sr_ldp_inter/#sr-ldp-domains","title":"SR &amp; LDP Domains","text":"<p>Except for the border routers, P3 and P7, remove LDP from the left part of the topology.</p> PE1P2P6 <pre><code>router isis IGP\naddress-family ipv4 unicast\nno mpls ldp auto-config </code></pre> <pre><code>router isis IGP\naddress-family ipv4 unicast\nno mpls ldp auto-config\n</code></pre> <pre><code>router isis IGP\naddress-family ipv4 unicast\nno mpls ldp auto-config\n</code></pre>"},{"location":"sr_ldp_inter/#verify","title":"Verify","text":"<p>Failure</p> <p>Because there is no end-to-end LDP, a traceroute from PE1 to PE5 would no longer operate. Label stitching is required to switch the traffic between the two domains.</p> <pre><code>RP/0/RP0/CPU0:PE1#traceroute mpls ipv4 5.5.5.5/32\nWed Feb  1 06:15:47.515 UTC\nTracing MPLS Label Switched Path to 5.5.5.5/32, timeout is 2 seconds\nCodes: '!' - success, 'Q' - request not sent, '.' - timeout,\n'L' - labeled output interface, 'B' - unlabeled output interface,\n'D' - DS Map mismatch, 'F' - no FEC mapping, 'f' - FEC mismatch,\n'M' - malformed request, 'm' - unsupported tlvs, 'N' - no rx label,\n'P' - no rx intf label prot, 'p' - premature termination of LSP,\n'R' - transit router, 'I' - unknown upstream index,\n'X' - unknown return code, 'x' - return code 0\nType escape sequence to abort.\n0 0.0.0.0 MRU 0 [No Label]\nQ 1 *\nRP/0/RP0/CPU0:PE1#\n</code></pre>"},{"location":"sr_ldp_inter/#stitch-ldp-to-sr","title":"Stitch LDP to SR","text":"<p>LDP to SR label swap</p> <p>This aspect is straightforward with the Cisco IOS-XR architecture, and the border router between the two domains handles it automatically.</p> <p>LDP labels are used for traffic coming from the LDP domain since LDP creates a label for each route in the routing table. The border router utilises the SR label to forward traffic in the SR domain.</p>"},{"location":"sr_ldp_inter/#verify_1","title":"Verify","text":"<pre><code>LRP/0/RP0/CPU0:PE5#traceroute mpls ipv4 1.1.1.1/32\nWed Feb  1 06:16:47.175 UTC\nTracing MPLS Label Switched Path to 1.1.1.1/32, timeout is 2 seconds\nCodes: '!' - success, 'Q' - request not sent, '.' - timeout,\n'L' - labeled output interface, 'B' - unlabeled output interface,\n'D' - DS Map mismatch, 'F' - no FEC mapping, 'f' - FEC mismatch,\n'M' - malformed request, 'm' - unsupported tlvs, 'N' - no rx label,\n'P' - no rx intf label prot, 'p' - premature termination of LSP,\n'R' - transit router, 'I' - unknown upstream index,\n'X' - unknown return code, 'x' - return code 0\nType escape sequence to abort.\n0 45.0.0.5 MRU 1500 [Labels: 24013 Exp: 0]\nL 1 45.0.0.4 MRU 1500 [Labels: 24014 Exp: 0] 17 ms\nL 2 34.0.0.3 MRU 1500 [Labels: 16001 Exp: 0] 13 ms // (1)\nL 3 23.0.0.2 MRU 1500 [Labels: implicit-null Exp: 0] 13 ms\n! 4 12.0.0.1 37 ms\nRP/0/RP0/CPU0:PE5#\n</code></pre> <ol> <li>LDP Label 24014 stitched to SR Label 16001</li> </ol> <p>P4 routed traffic via the LDP label to P3, which delivered it via the SR label across the SR domain.</p> <p>To route traffic to PE1, P3 swaps an incoming LDP label with an outgoing SR label 16001.</p> <p>Let's take a look at the label forwarding table and the cef entry on P3.</p> <p>P3 is utilising SR labels to route traffic for prefix 1.1.1.1/32; traffic arriving with SR labels as well as LDP labels now has an SR outgoing label. P3 copied the SR label for 1.1.1.1/32 to the unlabeled LDP outgoing label.</p> <pre><code>RP/0/RP0/CPU0:P3#show cef 1.1.1.1/32\nWed Feb  1 06:19:10.431 UTC\n1.1.1.1/32, version 144, labeled SR, internal 0x1000001 0x8310 (ptr 0xe6a41e0) [1], 0x600 (0xd944f08), 0xa28 (0xeb60968)\nUpdated Feb  1 06:10:11.114\nremote adjacency to GigabitEthernet0/0/0/0\nPrefix Len 32, traffic index 0, precedence n/a, priority 1\ngateway array (0xd7ad8d8) reference count 3, flags 0x68, source rib (7), 1 backups\n[2 type 5 flags 0x8401 (0xebae128) ext 0x0 (0x0)]\nLW-LDI[type=5, refc=3, ptr=0xd944f08, sh-ldi=0xebae128]\ngateway array update type-time 1 Feb  1 06:10:11.115\nLDI Update time Feb  1 06:10:11.115\nLW-LDI-TS Feb  1 06:10:11.115\nvia 23.0.0.2/32, GigabitEthernet0/0/0/0, 12 dependencies, weight 0, class 0 [flags 0x0]\npath-idx 0 NHID 0x0 [0xf399a10 0x0]\nnext hop 23.0.0.2/32\nremote adjacency\nlocal label 16001      labels imposed {16001} // (1)\nLoad distribution: 0 (refcount 2)\nHash  OK  Interface                 Address\n0     Y   GigabitEthernet0/0/0/0    remote\nRP/0/RP0/CPU0:P3#\nRP/0/RP0/CPU0:P3#show mpls  forwarding prefix 1.1.1.1/32\nWed Feb  1 06:19:12.950 UTC\nLocal  Outgoing    Prefix             Outgoing     Next Hop        Bytes\nLabel  Label       or ID              Interface                    Switched\n------ ----------- ------------------ ------------ --------------- ------------\n16001  16001       SR Pfx (idx 1)     Gi0/0/0/0    23.0.0.2        0\nRP/0/RP0/CPU0:P3#\nRP/0/RP0/CPU0:P3#show mpls ldp forwarding 1.1.1.1/32\nWed Feb  1 06:19:14.431 UTC\nCodes:\n- = GR label recovering, (!) = LFA FRR pure backup path\n{} = Label stack with multi-line output for a routing path\nG = GR, S = Stale, R = Remote LFA FRR backup\nE = Entropy label capability\nPrefix          Label   Label(s)       Outgoing     Next Hop            Flags\nIn      Out            Interface                        G S R E\n--------------- ------- -------------- ------------ ------------------- -------\n1.1.1.1/32      24014   Unlabelled     Gi0/0/0/0    23.0.0.2  // (2)\nUnlabelled     Gi0/0/0/1    37.0.0.7        (!)\nRP/0/RP0/CPU0:P3#\nRP/0/RP0/CPU0:P3#show mpls forwarding labels 24014\nWed Feb  1 06:19:17.188 UTC\nLocal  Outgoing    Prefix             Outgoing     Next Hop        Bytes\nLabel  Label       or ID              Interface                    Switched\n------ ----------- ------------------ ------------ --------------- ------------\n24014  16001       1.1.1.1/32         Gi0/0/0/0    23.0.0.2        240      // (3)\nRP/0/RP0/CPU0:P3#\nRP/0/RP0/CPU0:P3#show cef mpls local-label 24014 eOS detail\nWed Feb  1 06:19:45.214 UTC\nLabel/EOS 24014/1, Label-type Unknown, version 97, labeled SR, internal 0x1000001 0x87f0 (ptr 0xdb2f9c0) [1], 0x600 (0xd944f50), 0xa28 (0xeb604b8)\nUpdated Feb  1 06:15:12.318\nremote adjacency to GigabitEthernet0/0/0/0\nPrefix Len 21, traffic index 0, precedence n/a, priority 15\nExtensions: context-label:16001\ngateway array (0xd7ad9c0) reference count 2, flags 0x48, source lsd (5), 0 backups\n[2 type 6 flags 0x8401 (0xebae188) ext 0x0 (0x0)]\nLW-LDI[type=6, refc=2, ptr=0xd944f50, sh-ldi=0xebae188]\ngateway array update type-time 1 Feb  1 06:00:26.469\nLDI Update time Feb  1 06:10:11.115\nLW-LDI-TS Feb  1 06:15:12.319\nvia 23.0.0.2/32, GigabitEthernet0/0/0/0, 12 dependencies, weight 0, class 0 [flags 0x0]\npath-idx 0 NHID 0x0 [0xf399a10 0x0]\nnext hop 23.0.0.2/32\nremote adjacency\nlocal label 24014      labels imposed {16001}\nLoad distribution: 0 (refcount 2)\nHash  OK  Interface                 Address\n0     Y   GigabitEthernet0/0/0/0    remote\nRP/0/RP0/CPU0:P3#\n</code></pre> <ol> <li>SR labeled path to PE1</li> <li>PE1 is in SR-only domain, so no LDP path</li> <li>P3 replicates the SR label to the Unlabelled LDP outgoing label in order to connect the LDP label switched path to the SR label switched path.</li> </ol> <p>However, traffic from PE1 to PE5 continues to drop because the SR domain lacks a label switched path to LDP routers and ISIS LSP cannot distribute LDP labels.</p> <p>SRMS (Segment Routing Mapping Server) is the answer to the problem in the SR to LDP direction.</p>"},{"location":"sr_ldp_inter/#stitch-sr-to-ldp-with-srms","title":"Stitch SR to LDP (with SRMS)","text":"<p>SRMS (Segment Routing Mapping Server) is a control-plane-only function that broadcasts prefix-sid values for routers outside the SR domain.</p> <p>Unique Prefix-SIDs are defined in SRMS for non-SR routers, and ISIS is tasked with advertising those SIDs in the IGP domain, such that all SR routers have an SR label for the non-SR routers.</p> <p>In our topology, P6 would be SRMS.</p> <p>Note</p> <p>There is no need to configure the SID for P4 and P8, because the P nodes in an MPLS VPN network are never destination nodes; they are always in transit. This configuration is merely for the sake of consistency and completeness.</p> P6 (SRMS) <pre><code>segment-routing\nmapping-server\nprefix-sid-map\naddress-family ipv4\n4.4.4.4/32 4\n5.5.5.5/32 5\n8.8.8.8/32 8\nrouter isis IGP\naddress-family ipv4 unicast\nsegment-routing prefix-sid-map advertise-local\n</code></pre>"},{"location":"sr_ldp_inter/#verify_2","title":"Verify","text":"<p>The prefix-sid mappings are announced in ISIS, and all SR routers in the topology utilise them to forward traffic to a specific non-SR destination.</p> <p>The CEF entry below shows that the border router swaps the SR label for the LDP label in order to switch traffic from the SR domain to the LDP domain.</p> <pre><code>RP/0/RP0/CPU0:P3#show cef 5.5.5.5/32\nWed Feb  1 06:21:14.484 UTC\n5.5.5.5/32, version 167, labeled SR, internal 0x1000001 0x87f0 (ptr 0xe6a5218) [1], 0x600 (0xd9447b8), 0xa28 (0xeb60788)\nUpdated Feb  1 06:21:02.171\nremote adjacency to GigabitEthernet0/0/0/2\nPrefix Len 32, traffic index 0, precedence n/a, priority 15\ngateway array (0xd7ac5d0) reference count 3, flags 0x68, source rib (7), 2 backups\n[2 type 5 flags 0x8401 (0xebadbe8) ext 0x0 (0x0)]\nLW-LDI[type=5, refc=3, ptr=0xd9447b8, sh-ldi=0xebadbe8]\ngateway array update type-time 1 Feb  1 06:21:02.171\nLDI Update time Feb  1 06:21:02.179\nLW-LDI-TS Feb  1 06:21:02.179\nvia 34.0.0.4/32, GigabitEthernet0/0/0/2, 16 dependencies, weight 0, class 0 [flags 0x0]\npath-idx 0 NHID 0x0 [0xf3998d0 0x0]\nnext hop 34.0.0.4/32\nremote adjacency\nlocal label 16005      labels imposed {24000}\nLoad distribution: 0 (refcount 2)\nHash  OK  Interface                 Address\n0     Y   GigabitEthernet0/0/0/2    remote\nRP/0/RP0/CPU0:P3#\n</code></pre> <pre><code>RP/0/RP0/CPU0:PE1#traceroute sr-mpls 5.5.5.5/32\nWed Feb  1 06:22:44.329 UTC\nTracing MPLS Label Switched Path to 5.5.5.5/32, timeout is 2 seconds\nCodes: '!' - success, 'Q' - request not sent, '.' - timeout,\n'L' - labeled output interface, 'B' - unlabeled output interface,\n'D' - DS Map mismatch, 'F' - no FEC mapping, 'f' - FEC mismatch,\n'M' - malformed request, 'm' - unsupported tlvs, 'N' - no rx label,\n'P' - no rx intf label prot, 'p' - premature termination of LSP,\n'R' - transit router, 'I' - unknown upstream index,\n'X' - unknown return code, 'x' - return code 0\nType escape sequence to abort.\n0 12.0.0.1 MRU 1500 [Labels: 16005 Exp: 0]\nL 1 12.0.0.2 MRU 1500 [Labels: 16005 Exp: 0] 13 ms\nL 2 27.0.0.7 MRU 1500 [Labels: 24000 Exp: 0] 10 ms\nL 3 47.0.0.4 MRU 1500 [Labels: implicit-null Exp: 0] 21 ms\n! 4 45.0.0.5 13 ms\nRP/0/RP0/CPU0:PE1#\n</code></pre>"},{"location":"sr_ldp_inter/#sr-only-domain","title":"SR-Only Domain","text":"<p>Configure SR on the topology's remaining routers.</p> P4PE5P8 <pre><code>router isis IGP\naddress-family ipv4 unicast\nsegment-routing mpls sr-prefer\n!\ninterface Loopback0\naddress-family ipv4 unicast\nprefix-sid index 4\n</code></pre> <pre><code>router isis IGP\naddress-family ipv4 unicast\nsegment-routing mpls sr-prefer\n!\ninterface Loopback0\naddress-family ipv4 unicast\nprefix-sid index 5\n</code></pre> <pre><code>router isis IGP\naddress-family ipv4 unicast\nsegment-routing mpls sr-prefer\n!\ninterface Loopback0\naddress-family ipv4 unicast\nprefix-sid index 8\n</code></pre> <p>Remove LDP from all of the topology's routers.</p> All Routers <pre><code>router isis IGP\naddress-family ipv4 unicast\nno mpls ldp auto-config\n</code></pre> <p>Remove SRMS as well.</p> P6 <pre><code>router isis IGP\naddress-family ipv4 unicast\nno segment-routing prefix-sid-map advertise-local\n!\n!\nno segment-routing\n</code></pre>"},{"location":"ss_tilfa/","title":"Single Segment TI-LFA (Topology Independent - LoopFree Alternate)","text":"Single Segment TI-LFA <p>Single Segment TI-LFA is a backup route in which the router delivers traffic to the destination after adding one additional segment to the original segment in the event of a local link failure.</p>"},{"location":"ss_tilfa/#prepare-the-topology","title":"Prepare the topology","text":"<p>Because there were numerous short paths to P4, create a ring topology by closing off three isis adjacencies on P7.</p> <p>To protect the link between P2 and P3, the P2 router now has a backup route through P8, which is the post-convergence path in the event of the previously described link failure.</p> P7 <pre><code>router isis IGP\ninterface GigabitEthernet0/0/0/1\nshutdown\n!\ninterface GigabitEthernet0/0/0/3\nshutdown\n!\ninterface GigabitEthernet0/0/0/4\nshutdown\n</code></pre>"},{"location":"ss_tilfa/#verify","title":"Verify","text":"P2's P-spaceP-space of P6 (P2's neighbor)Extended P-space of P2, with respect to P2 - P3 link <pre><code>Routers P2 can reach without using P2 - P3 link (excluding ECMP)\n    1. P6\n    2. P7\n</code></pre> <pre><code>Routers P6 can reach without using P2 - P3 link\n    1. P7\n    2. P8\n</code></pre> <pre><code>1. P6\n2. P7\n3. P8\n</code></pre> <p>P8 is in Extended-P-space (or P-node) (P2 can send packets to P8 without any risk of packet flowing via P2 \u2013 P3).</p> <p>P8 is also in Q-space (P8 can send packets to destination PE5, without any risk of packet flowing via P2 \u2013 P3).</p> <p>P2 would need to tunnel the original segment to P8 across the intermediate hops, which is why it imposes an extra segment, thus the term single segment ti-lfa.</p> <p>The backup route on P2 includes the Prefix-SID of P8 as the top label and the Prefix-SID of PE5 as the bottom label, directing traffic first to P8 and then to PE5, with no possibility of it passing via P2 - P3.</p> Single Segment TI-LFA <pre><code>RP/0/RP0/CPU0:P2#show isis fast-reroute 5.5.5.5/32 detail\nWed Feb  1 07:33:32.000 UTC\nL2 5.5.5.5/32 [30/115] Label: 16005, medium priority\nInstalled Feb 01 07:33:06.856 for 00:00:26\nvia 23.0.0.3, GigabitEthernet0/0/0/0, Label: 16005, P3, SRGB Base: 16000, Weight: 0\nBackup path: TI-LFA (link), via 26.0.0.6, GigabitEthernet0/0/0/1 P6, SRGB Base: 16000, Weight: 0, Metric: 50\nP node: P8.00 [8.8.8.8], Label: 16008  // (1)\nPrefix label: 16005\nBackup-src: PE5.00\nP: No, TM: 50, LC: No, NP: No, D: No, SRLG: Yes\nsrc PE5.00-00, 5.5.5.5, prefix-SID index 5, R:0 N:1 P:0 E:0 V:0 L:0, Alg:0\nRP/0/RP0/CPU0:P2#\nRP/0/RP0/CPU0:P2#show cef 5.5.5.5/32\nWed Feb  1 07:33:45.503 UTC\n5.5.5.5/32, version 444, labeled SR, internal 0x1000001 0x8310 (ptr 0xe727de0) [1], 0x600 (0xe190578), 0xa28 (0xf54a0a8)\nUpdated Feb  1 07:33:06.863\nremote adjacency to GigabitEthernet0/0/0/0\nPrefix Len 32, traffic index 0, precedence n/a, priority 1\ngateway array (0xdff97f0) reference count 6, flags 0x500068, source rib (7), 1 backups\n[3 type 5 flags 0x8401 (0xeb73a68) ext 0x0 (0x0)]\nLW-LDI[type=5, refc=3, ptr=0xe190578, sh-ldi=0xeb73a68]\ngateway array update type-time 1 Feb  1 07:33:06.863\nLDI Update time Feb  1 07:33:06.863\nLW-LDI-TS Feb  1 07:33:06.863\nvia 23.0.0.3/32, GigabitEthernet0/0/0/0, 14 dependencies, weight 0, class 0, protected [flags 0x400]\npath-idx 0 bkup-idx 1 NHID 0x0 [0xdda5820 0x0]\nnext hop 23.0.0.3/32\nlocal label 16005      labels imposed {16005}       // (2)\nvia 26.0.0.6/32, GigabitEthernet0/0/0/1, 11 dependencies, weight 0, class 0, backup (TI-LFA) [flags 0xb00]\npath-idx 1 NHID 0x0 [0xf399970 0x0]\nnext hop 26.0.0.6/32, Repair Node(s): 8.8.8.8\nremote adjacency\nlocal label 16005      labels imposed {16008 16005}  // (3)\nLoad distribution: 0 (refcount 3)\nHash  OK  Interface                 Address\n0     Y   GigabitEthernet0/0/0/0    remote\nRP/0/RP0/CPU0:P2#\n</code></pre> <ol> <li>1 additional segment added to the original prefix-sid on the backup path</li> <li>Primary route has destination prefix-sid label</li> <li>Backup route has an additional label in the data-plane</li> </ol>"},{"location":"tilfa/","title":"TI-LFA (Topology Independent - LoopFree Alternate)","text":"SR Only <p>To offer FRR protection for SR traffic in the data plane, TI-LFA (Topology Independent LoopFree Alternate) would be activated. </p> <p>It accomplishes this by generating a backup route for each route in the network.</p> <p>The post-convergence path is calculated and installed as the backup route in both the route table and the forwarding table by TI-LFA.</p>"},{"location":"tilfa/#configuration","title":"Configuration","text":"PE1P2P3P4PE5P6P7P8 <pre><code>router isis IGP\ninterface GigabitEthernet0/0/0/2\naddress-family ipv4 unicast\nfast-reroute per-prefix\nfast-reroute per-prefix ti-lfa\n</code></pre> <pre><code>router isis IGP\ninterface GigabitEthernet0/0/0/0\naddress-family ipv4 unicast\nfast-reroute per-prefix\nfast-reroute per-prefix ti-lfa\n!\n!\ninterface GigabitEthernet0/0/0/1\naddress-family ipv4 unicast\nfast-reroute per-prefix\nfast-reroute per-prefix ti-lfa\n!\n!\ninterface GigabitEthernet0/0/0/2\naddress-family ipv4 unicast\nfast-reroute per-prefix\nfast-reroute per-prefix ti-lfa\n!\n!\ninterface GigabitEthernet0/0/0/3\naddress-family ipv4 unicast\nfast-reroute per-prefix\nfast-reroute per-prefix ti-lfa\n</code></pre> <pre><code>router isis IGP\ninterface GigabitEthernet0/0/0/0\naddress-family ipv4 unicast\nfast-reroute per-prefix\nfast-reroute per-prefix ti-lfa\n!\n!\ninterface GigabitEthernet0/0/0/1\naddress-family ipv4 unicast\nfast-reroute per-prefix\nfast-reroute per-prefix ti-lfa\n!\n!\ninterface GigabitEthernet0/0/0/2\naddress-family ipv4 unicast\nfast-reroute per-prefix\nfast-reroute per-prefix ti-lfa\n</code></pre> <pre><code>router isis IGP\ninterface GigabitEthernet0/0/0/0\naddress-family ipv4 unicast\nfast-reroute per-prefix\nfast-reroute per-prefix ti-lfa\n!\n!\ninterface GigabitEthernet0/0/0/1\naddress-family ipv4 unicast\nfast-reroute per-prefix\nfast-reroute per-prefix ti-lfa\n!\n!\ninterface GigabitEthernet0/0/0/2\naddress-family ipv4 unicast\nfast-reroute per-prefix\nfast-reroute per-prefix ti-lfa\n!\n!\ninterface GigabitEthernet0/0/0/4\naddress-family ipv4 unicast\nfast-reroute per-prefix\nfast-reroute per-prefix ti-lfa\n</code></pre> <pre><code>router isis IGP\ninterface GigabitEthernet0/0/0/0\naddress-family ipv4 unicast\nfast-reroute per-prefix\nfast-reroute per-prefix ti-lfa\n</code></pre> <pre><code>router isis IGP\ninterface GigabitEthernet0/0/0/0\naddress-family ipv4 unicast\nfast-reroute per-prefix\nfast-reroute per-prefix ti-lfa\n!\n!\ninterface GigabitEthernet0/0/0/1\naddress-family ipv4 unicast\nfast-reroute per-prefix\nfast-reroute per-prefix ti-lfa\n</code></pre> <pre><code>router isis IGP\ninterface GigabitEthernet0/0/0/0\naddress-family ipv4 unicast\nfast-reroute per-prefix\nfast-reroute per-prefix ti-lfa\n!\n!\ninterface GigabitEthernet0/0/0/1\naddress-family ipv4 unicast\nfast-reroute per-prefix\nfast-reroute per-prefix ti-lfa\n!\n!\ninterface GigabitEthernet0/0/0/2\naddress-family ipv4 unicast\nfast-reroute per-prefix\nfast-reroute per-prefix ti-lfa\n!\n!\ninterface GigabitEthernet0/0/0/3\naddress-family ipv4 unicast\nfast-reroute per-prefix\nfast-reroute per-prefix ti-lfa\n!\n!\ninterface GigabitEthernet0/0/0/4\naddress-family ipv4 unicast\nfast-reroute per-prefix\nfast-reroute per-prefix ti-lfa\n</code></pre> <pre><code>router isis IGP\ninterface GigabitEthernet0/0/0/1\naddress-family ipv4 unicast\nfast-reroute per-prefix\nfast-reroute per-prefix ti-lfa\n!\n!\ninterface GigabitEthernet0/0/0/2\naddress-family ipv4 unicast\nfast-reroute per-prefix\nfast-reroute per-prefix ti-lfa\n</code></pre>"},{"location":"tilfa/#verify","title":"Verify","text":"TI-LFA Active <pre><code>RP/0/RP0/CPU0:P2#show isis interface GigabitEthernet 0/0/0/0\nWed Feb  1 06:32:38.963 UTC\nGigabitEthernet0/0/0/0      Enabled\nAdjacency Formation:      Enabled\nPrefix Advertisement:     Enabled\nIPv4 BFD:                 Disabled\nIPv6 BFD:                 Disabled\nBFD Min Interval:         150\nBFD Multiplier:           3\nRSI SRLG:                 Registered\nBandwidth:                1000000\nCircuit Type:             level-2-only\nMedia Type:               P2P\nCircuit Number:           0\nMeasured Delay:           Min:- Avg:- Max:- usec\nDelay Normalization:      Interval:0 Offset:0\nNormalized Delay:         Min:- Avg:- Max:- usec\nLink Loss:                -\nExtended Circuit Number:  7\nNext P2P IIH in:          3 s\nLSP Rexmit Queue Size:    0\nLevel-2\nAdjacency Count:        1\nLSP Pacing Interval:    33 ms\nPSNP Entry Queue Size:  0\nHello Interval:         10 s\nHello Multiplier:       3\nCLNS I/O\nProtocol State:         Up\nMTU:                    1497\nSNPA:                   5005.0004.0003\nLayer-2 MCast Groups Membership:\nAll ISs:              Yes\nIPv4 Unicast Topology:    Enabled\nAdjacency Formation:    Running\nPrefix Advertisement:   Running\nPolicy (L1/L2):   -/-\nMetric (L1/L2):         0/10\nMetric fallback:\nBandwidth (L1/L2):    Inactive/Inactive\nAnomaly (L1/L2):      Inactive/Inactive\nWeight (L1/L2):         0/0\nMPLS Max Label Stack:   3/3/10/10 (PRI/BKP/SRTE/SRAT)\nMPLS LDP Sync (L1/L2):  Disabled/Disabled\nFRR (L1/L2):            L1 Enabled         L2 Enabled FRR Type:             per-prefix         per-prefix\nDirect LFA:           Enabled            Enabled\nRemote LFA:           Not Enabled        Not Enabled\nTie Breaker          Default            Default\nLine-card disjoint   30                 30\nLowest backup metric 20                 20\nNode protecting      40                 40\nPrimary path         10                 10\nTI LFA:               Enabled            Enabled  // (1)\nTie Breaker          Default            Default\nLink Protecting      Enabled            Enabled  // (2)\nLine-card disjoint   0                  0     Node protecting      0                  0        // (3)\nSRLG disjoint        0                  0\nIPv4 Address Family:      Enabled\nProtocol State:         Up\nForwarding Address(es): 23.0.0.2\nGlobal Prefix(es):      23.0.0.0/24\nLSP transmit timer expires in 0 ms\nLSP transmission is idle\nCan send up to 9 back-to-back LSPs in the next 0 ms\nRP/0/RP0/CPU0:P2#\n</code></pre> <ol> <li>TI-LFA is enabled now on the interface</li> <li>Link Protection is the default protection mode in TI-LFA</li> <li>Node and SRLG protection would be enabled later on in the guide</li> </ol> Backup Path <pre><code>RP/0/RP0/CPU0:P2#show isis fast-reroute 5.5.5.5/32 detail\nWed Feb  1 06:34:56.805 UTC\nL2 5.5.5.5/32 [30/115] Label: 16005, medium priority\nInstalled Feb 01 06:30:04.625 for 00:04:52\nvia 23.0.0.3, GigabitEthernet0/0/0/0, Label: 16005, P3, SRGB Base: 16000, Weight: 0\nBackup path: LFA, via 27.0.0.7, GigabitEthernet0/0/0/3, Label: 16005, P7, SRGB Base: 16000, Weight: 0, Metric: 30\nP: Yes, TM: 30, LC: No, NP: Yes, D: Yes, SRLG: Yes\nvia 27.0.0.7, GigabitEthernet0/0/0/3, Label: 16005, P7, SRGB Base: 16000, Weight: 0\nBackup path: LFA, via 23.0.0.3, GigabitEthernet0/0/0/0, Label: 16005, P3, SRGB Base: 16000, Weight: 0, Metric: 30\nP: Yes, TM: 30, LC: No, NP: Yes, D: Yes, SRLG: Yes\nsrc PE5.00-00, 5.5.5.5, prefix-SID index 5, R:0 N:1 P:0 E:0 V:0 L:0, Alg:0\nRP/0/RP0/CPU0:P2#\nRP/0/RP0/CPU0:P2#show route 5.5.5.5/32\nWed Feb  1 06:35:42.620 UTC\nRouting entry for 5.5.5.5/32\nKnown via \"isis IGP\", distance 115, metric 30, labeled SR, type level-2\nInstalled Feb  1 06:30:04.626 for 00:05:38\nRouting Descriptor Blocks\n23.0.0.3, from 5.5.5.5, via GigabitEthernet0/0/0/0, Protected, ECMP-Backup (Local-LFA)\nRoute metric is 30\n27.0.0.7, from 5.5.5.5, via GigabitEthernet0/0/0/3, Protected, ECMP-Backup (Local-LFA)\nRoute metric is 30\nNo advertising protos.\nRP/0/RP0/CPU0:P2#\n</code></pre>"},{"location":"tilfa_gw_srlg/","title":"TI-LFA Global Weighted SRLG Protection","text":"TI-LFA Global Weighted SRLG Protection <p>If a distant connection with the same SRLG but not directly linked to P2 was included in the backup path computation, the local SRLG protection would fail.</p> <p>By incorporating all SRLG links in a region, Global Weighted SRLG provides superior protection.</p> <p>SRLG information can be advertised in ISIS, or static SRLGs (out of scope) can be configured manually for distant connectivity.</p> <p>Include P7 - P3 in the same SRLG group 100 as the other two connections.</p>"},{"location":"tilfa_gw_srlg/#configuration","title":"Configuration","text":"Enable Global Weighted SRLG on P2 <pre><code>router isis IGP\naddress-family ipv4 unicast\nfast-reroute per-prefix srlg-protection weighted-global\n</code></pre> Advertise SRLG from P7 <pre><code>srlg\ninterface GigabitEthernet0/0/0/1\nname SRLG-100\n!\nname SRLG-100\nvalue 100\nrouter isis IGP address-family ipv4 unicast advertise application lfa link-attributes srlg\n</code></pre>"},{"location":"tilfa_gw_srlg/#verify","title":"Verify","text":"<p>P6 is located in P-space (or P-node) (P2 can send the traffic to P6 without any risk of flowing via P2 \u2013 P3)</p> <p>P7 is located in Q-space (or Q-node) (P7 can send the traffic to the destination without any risk of flowing via P2 \u2013 P3)</p> <p>The backup path on P2 reveals two extra Adj-SID labels 24019 and 24014 to compel the traffic to use P6 - P7 and then P7 - P4 link, due to SRLG protection.</p> <p>TI-LFA employs the Application Specific SRLG mentioned in TLV 238.</p> <p>MPLS SRLG</p> <p>RSVP-TE uses the MPLS SRLG advertised in TLV 138, TI-LFA does not use it</p> <pre><code>RP/0/RP0/CPU0:P2#show isis database verbose internal P7\n&lt;..snipped..&gt;\nTLV code:138 length:20\nMPLS SRLG:      P3.00\nLocal Interface ID: 8\nRemote Interface ID: 8\nFlags: 0x0\nSRLGs:\n[0]: 100\nTLV code:238 length:26\nApplication Specific SRLG: P3.00\nL flag: 0, SA-Length 1, UDA-Length 1\nStandard Applications: 0x20 LFA\nUser Defined Applications: 0x20 LFA\nSub-TLV Length: 10\nSubTLV code:4 length:8\nLocal Interface ID: 8, Remote Interface ID: 8\nSRLGs:\n[0]: 100\nTotal Level-2 LSP count: 1     Local Level-2 LSP count: 0\nRP/0/RP0/CPU0:P2#\n</code></pre> <p>Because the P7 - P3 connection exceeds the mpls max label stack 3, the SRLG-based TI-LFA initiates an SR auto-tunnel as a backup route.</p> <p>If mpls traffic-engineering is not enabled as indicated in the handbook, the auto-tunnel will not appear.</p> Global Weighted SRLG Protection TI-LFA <pre><code>RP/0/RP0/CPU0:P2#show isis fast-reroute 5.5.5.5/32 detail\nWed Feb  1 09:37:45.061 UTC\nL2 5.5.5.5/32 [30/115] Label: 16005, medium priority\nInstalled Feb 01 09:33:14.976 for 00:04:31\nvia 23.0.0.3, GigabitEthernet0/0/0/0, Label: 16005, P3, SRGB Base: 16000, Weight: 0\nBackup path: TI-LFA (srlg), via 26.0.0.6, GigabitEthernet0/0/0/1 P6, SRGB Base: 16000, Weight: 0, Metric: 220\nBackup tunnel: tunnel-te32768\nP node: P6.00 [6.6.6.6], Label: ImpNull\nQ node: P7.00 [7.7.7.7], Label: 24019\nQ node: P4.00 [4.4.4.4], Label: 24014\nPrefix label: 16005\nBackup-src: PE5.00\nP: No, TM: 220, LC: No, NP: No, D: No, SRLG: Yes\nsrc PE5.00-00, 5.5.5.5, prefix-SID index 5, R:0 N:1 P:0 E:0 V:0 L:0, Alg:0\nRP/0/RP0/CPU0:P2#\n</code></pre>"},{"location":"tilfa_gw_srlg/#restore-topology","title":"Restore Topology","text":"Remove GW-SRLG on P2Stop advertising SRLG on P7 <pre><code>router isis IGP\naddress-family ipv4 unicast\nno fast-reroute per-prefix srlg-protection weighted-global\n</code></pre> <pre><code>no router isis IGP address-family ipv4 unicast advertise application lfa link-attributes srlg\n</code></pre>"},{"location":"tilfa_link_node_srlg/","title":"TI-LFA Tiebreaker (Link vs SRLG vs Node)","text":"SR + TI-LFA Base Topology"},{"location":"tilfa_link_node_srlg/#prepare-topology","title":"Prepare Topology","text":"<p>Add a new router, P9, to the old topology and configure it for SR-MPLS and TI-LFA.</p> P9P2P3 <pre><code>interface Loopback0\nipv4 address 9.9.9.9 255.255.255.255\n!\ninterface GigabitEthernet0/0/0/3\nipv4 address 39.0.0.9 255.255.255.0\nno shutdown\n!\ninterface GigabitEthernet0/0/0/5\nipv4 address 29.0.0.9 255.255.255.0\nno shutdown\n!\nrouter isis IGP\nis-type level-2-only\nnet 49.0000.0000.0009.00\nlog adjacency changes\naddress-family ipv4 unicast\nmetric-style wide level 2\nsegment-routing mpls sr-prefer\n!\ninterface Loopback0\npassive\naddress-family ipv4 unicast\nprefix-sid index 9\n!\n!\ninterface GigabitEthernet0/0/0/3\ncircuit-type level-2-only\npoint-to-point\nhello-padding disable\naddress-family ipv4 unicast\nfast-reroute per-prefix\nfast-reroute per-prefix ti-lfa\nmetric 10\n!\n!\ninterface GigabitEthernet0/0/0/5\ncircuit-type level-2-only\npoint-to-point\nhello-padding disable\naddress-family ipv4 unicast\nfast-reroute per-prefix\nfast-reroute per-prefix ti-lfa\nmetric 10\n!\n!\n!\nmpls oam\n</code></pre> <pre><code>interface GigabitEthernet0/0/0/5\nipv4 address 29.0.0.2 255.255.255.0\nno shutdown\n!\nrouter isis IGP\ninterface GigabitEthernet0/0/0/5\ncircuit-type level-2-only\npoint-to-point\nhello-padding disable\naddress-family ipv4 unicast\nfast-reroute per-prefix\nfast-reroute per-prefix ti-lfa\nmetric 10\n</code></pre> <pre><code>interface GigabitEthernet0/0/0/3\nipv4 address 39.0.0.3 255.255.255.0\nno shutdown\n!\nrouter isis IGP\ninterface GigabitEthernet0/0/0/3\ncircuit-type level-2-only\npoint-to-point\nhello-padding disable\naddress-family ipv4 unicast\nfast-reroute per-prefix\nfast-reroute per-prefix ti-lfa\nmetric 10\n</code></pre>"},{"location":"tilfa_link_node_srlg/#link-protection-preferred","title":"Link Protection Preferred","text":"<p>Add the link between P2 and P6 to the same SRLG group as P2 and P7 and P2 and P3.</p> P2Node+SRLG already configured on P2 <pre><code>srlg\ninterface GigabitEthernet0/0/0/1\nname SRLG-100\n</code></pre> <pre><code>RP/0/RP0/CPU0:P2#show run router isis\nTue Feb 1 12:02:21.985 UTC\nrouter isis IGP\n&lt;..snipped..&gt;\nfast-reroute per-prefix tiebreaker node-protecting index 200\nfast-reroute per-prefix tiebreaker srlg-disjoint index 100\n</code></pre> <p> </p> TI-LFA Link Protection Path Preferred <p>Link Protection Index</p> <p>We cannot adjust the lowest index (or maximum preference) for link protection.</p> P2 to PE5 primary path <ul> <li>P2 \u2013 P3 \u2013 P4 \u2013 PE5 (metric: 30)</li> </ul> The backup route computation from P2 to PE5 is as follows: Protection Via Path Metric Preference Link P9 P9 \u2013 P3 \u2013 P4 \u2013 PE5 40  1st SRLG P9 P9 \u2013 P3 \u2013 P4 \u2013 PE5 40 2nd Node P7 P7 \u2013 P4 \u2013 PE5 120 3rd <p>Link Protection Preferred</p> <p>Because node and srlg protection are not available concurrently, the tiebreaker chooses link protection computation as the best backup path, therefore ti-lfa falls back to link protection.</p> Link Protection Preferred <pre><code>RP/0/RP0/CPU0:P2#show isis fast-reroute 5.5.5.5/32 detail\nWed Feb  1 12:12:11.367 UTC\nL2 5.5.5.5/32 [30/115] Label: 16005, medium priority\nInstalled Feb 01 12:12:05.762 for 00:00:06\nvia 23.0.0.3, GigabitEthernet0/0/0/0, Label: 16005, P3, SRGB Base: 16000, Weight: 0\nBackup path: LFA, via 29.0.0.9, GigabitEthernet0/0/0/5, Label: 16005, P9, SRGB Base: 16000, Weight: 0, Metric: 40\nP: No, TM: 40, LC: No, NP: No, D: No, SRLG: Yes\nsrc PE5.00-00, 5.5.5.5, prefix-SID index 5, R:0 N:1 P:0 E:0 V:0 L:0, Alg:0\nRP/0/RP0/CPU0:P2#\nRP/0/RP0/CPU0:P2#show route 5.5.5.5/32\nWed Feb  1 12:12:17.549 UTC\nRouting entry for 5.5.5.5/32\nKnown via \"isis IGP\", distance 115, metric 30, labeled SR, type level-2\nInstalled Feb  1 12:12:05.762 for 00:00:11\nRouting Descriptor Blocks\n23.0.0.3, from 5.5.5.5, via GigabitEthernet0/0/0/0, Protected\nRoute metric is 30\n29.0.0.9, from 5.5.5.5, via GigabitEthernet0/0/0/5, Backup (Local-LFA)\nRoute metric is 40\nNo advertising protos.\nRP/0/RP0/CPU0:P2#\nRP/0/RP0/CPU0:P2#show cef 5.5.5.5/32\nWed Feb  1 12:12:55.469 UTC\n5.5.5.5/32, version 1340, labeled SR, internal 0x1000001 0x8310 (ptr 0xe727de0) [1], 0x600 (0xe190578), 0xa28 (0xf559100)\nUpdated Feb  1 12:12:05.768\nremote adjacency to GigabitEthernet0/0/0/0\nPrefix Len 32, traffic index 0, precedence n/a, priority 1\ngateway array (0xdffae98) reference count 6, flags 0x500068, source rib (7), 1 backups\n[3 type 5 flags 0x8401 (0xeb74608) ext 0x0 (0x0)]\nLW-LDI[type=5, refc=3, ptr=0xe190578, sh-ldi=0xeb74608]\ngateway array update type-time 1 Feb  1 12:12:05.767\nLDI Update time Feb  1 12:12:05.767\nLW-LDI-TS Feb  1 12:12:05.767\nvia 23.0.0.3/32, GigabitEthernet0/0/0/0, 10 dependencies, weight 0, class 0, protected [flags 0x400]\npath-idx 0 bkup-idx 1 NHID 0x0 [0xdda6ea0 0x0]\nnext hop 23.0.0.3/32\nlocal label 16005      labels imposed {16005}\nvia 29.0.0.9/32, GigabitEthernet0/0/0/5, 21 dependencies, weight 0, class 0, backup (Local-LFA) [flags 0x300]\npath-idx 1 NHID 0x0 [0xf399f10 0x0]\nnext hop 29.0.0.9/32\nremote adjacency\nlocal label 16005      labels imposed {16005}\nLoad distribution: 0 (refcount 3)\nHash  OK  Interface                 Address\n0     Y   GigabitEthernet0/0/0/0    remote\nRP/0/RP0/CPU0:P2(config)#\n</code></pre>"},{"location":"tilfa_link_node_srlg/#srlg-protection-preferred","title":"SRLG Protection Preferred","text":"<p>Increase the metric between P9 and P3, such that link protection is no longer available.</p> P9 <pre><code>router isis IGP\ninterface GigabitEthernet0/0/0/3\naddress-family ipv4 unicast\nmetric 100\n</code></pre> <p> </p> TI-LFA SRLG Protection Path Preferred P2 to PE5 primary path <ul> <li>P2 \u2013 P3 \u2013 P4 \u2013 PE5 (metric: 30)</li> </ul> The backup route computation from P2 to PE5 is as follows: Protection Via Path Metric Preference Link P7 P7 \u2013 P4 \u2013 PE5 120 NA (path has SRLG) SRLG P9 P9 \u2013 P3 \u2013 P4 \u2013 PE5 130  1st Node P7 P7 \u2013 P4 \u2013 PE5 120 2nd <p>SRLG Protection Preferred</p> <p>Because link protection alone is not available owing to clashes with SRLG links, and SRLG has a higher priority or lower index than Node protection, the tiebreaker favours SRLG-disjoint protection computation as the best backup option.</p> SRLG Protection Preferred <pre><code>RP/0/RP0/CPU0:P2#show isis fast-reroute 5.5.5.5/32 detail\nWed Feb  1 12:16:47.226 UTC\nL2 5.5.5.5/32 [30/115] Label: 16005, medium priority\nInstalled Feb 01 12:13:34.896 for 00:03:13\nvia 23.0.0.3, GigabitEthernet0/0/0/0, Label: 16005, P3, SRGB Base: 16000, Weight: 0\nBackup path: TI-LFA (srlg), via 29.0.0.9, GigabitEthernet0/0/0/5 P9, SRGB Base: 16000, Weight: 0, Metric: 130\nP node: P9.00 [9.9.9.9], Label: ImpNull\nQ node: P3.00 [3.3.3.3], Label: 24001\nPrefix label: 16005\nBackup-src: PE5.00\nP: No, TM: 130, LC: No, NP: No, D: No, SRLG: Yes\nsrc PE5.00-00, 5.5.5.5, prefix-SID index 5, R:0 N:1 P:0 E:0 V:0 L:0, Alg:0\nRP/0/RP0/CPU0:P2#\nRP/0/RP0/CPU0:P2#show route 5.5.5.5/32\nWed Feb  1 12:16:56.680 UTC\nRouting entry for 5.5.5.5/32\nKnown via \"isis IGP\", distance 115, metric 30, labeled SR, type level-2\nInstalled Feb  1 12:13:34.897 for 00:03:21\nRouting Descriptor Blocks\n23.0.0.3, from 5.5.5.5, via GigabitEthernet0/0/0/0, Protected\nRoute metric is 30\n29.0.0.9, from 5.5.5.5, via GigabitEthernet0/0/0/5, Backup (TI-LFA)\nRepair Node(s): 9.9.9.9, 3.3.3.3\nRoute metric is 130\nNo advertising protos.\nRP/0/RP0/CPU0:P2#\nRP/0/RP0/CPU0:P2#show cef 5.5.5.5/32\nWed Feb  1 12:17:07.318 UTC\n5.5.5.5/32, version 1371, labeled SR, internal 0x1000001 0x8310 (ptr 0xe727de0) [1], 0x600 (0xe191460), 0xa28 (0xf559628)\nUpdated Feb  1 12:13:34.914\nremote adjacency to GigabitEthernet0/0/0/0\nPrefix Len 32, traffic index 0, precedence n/a, priority 1\ngateway array (0xdffb890) reference count 6, flags 0x500068, source rib (7), 1 backups\n[5 type 4 flags 0x8401 (0xeb74008) ext 0x0 (0x0)]\nLW-LDI[type=1, refc=1, ptr=0xe191460, sh-ldi=0xeb74008]\ngateway array update type-time 1 Feb  1 12:13:34.914\nLDI Update time Feb  1 12:13:34.914\nLW-LDI-TS Feb  1 12:13:34.914\nvia 23.0.0.3/32, GigabitEthernet0/0/0/0, 14 dependencies, weight 0, class 0, protected [flags 0x400]\npath-idx 0 bkup-idx 1 NHID 0x0 [0xdda6ea0 0xdda6ea0]\nnext hop 23.0.0.3/32\nlocal label 16005      labels imposed {16005}\nvia 29.0.0.9/32, GigabitEthernet0/0/0/5, 22 dependencies, weight 0, class 0, backup (TI-LFA) [flags 0xb00]\npath-idx 1 NHID 0x0 [0xf399f10 0x0]\nnext hop 29.0.0.9/32, Repair Node(s): 9.9.9.9, 3.3.3.3\nremote adjacency\nlocal label 16005      labels imposed {ImplNull 24001 16005}\nLoad distribution: 0 (refcount 5)\nHash  OK  Interface                 Address\n0     Y   GigabitEthernet0/0/0/0    remote\nRP/0/RP0/CPU0:P2#\n</code></pre>"},{"location":"tilfa_link_node_srlg/#node-protection-preferred","title":"Node Protection Preferred","text":"<p>Increase the SRLG index to make node-protection the preferable option.</p> P2 <pre><code>router isis IGP\naddress-family ipv4 unicast\nfast-reroute per-prefix tiebreaker srlg-disjoint index 255\n</code></pre> <p> </p> TI-LFA NODE Protection Path Preferred P2 to PE5 primary path <ul> <li>P2 \u2013 P3 \u2013 P4 \u2013 PE5 (metric: 30)</li> </ul> The backup route computation from P2 to PE5 is as follows: Protection Via Path Metric Preference Link P7 P7 \u2013 P4 \u2013 PE5 120 NA (path has SRLG) SRLG P9 P9 \u2013 P3 \u2013 P4 \u2013 PE5 130 2nd Node P7 P7 \u2013 P4 \u2013 PE5 120  1st <p>Node Protection Preferred</p> <p>Because it has a lower index or higher priority than SRLG, the tiebreaker selects Node protection calculation as the optimal backup path. Furthermore, link protection is not available on its own.</p> Node Protection Preferred <pre><code>RP/0/RP0/CPU0:P2#show isis fast-reroute 5.5.5.5/32 detail\nWed Feb  1 12:18:04.104 UTC\nL2 5.5.5.5/32 [30/115] Label: 16005, medium priority\nInstalled Feb 01 12:17:48.448 for 00:00:16\nvia 23.0.0.3, GigabitEthernet0/0/0/0, Label: 16005, P3, SRGB Base: 16000, Weight: 0\nBackup path: TI-LFA (node), via 27.0.0.7, GigabitEthernet0/0/0/3 P7, SRGB Base: 16000, Weight: 0, Metric: 120\nP node: P7.00 [7.7.7.7], Label: ImpNull\nQ node: P4.00 [4.4.4.4], Label: 24014\nPrefix label: 16005\nBackup-src: PE5.00\nP: No, TM: 120, LC: No, NP: Yes, D: No, SRLG: No\nsrc PE5.00-00, 5.5.5.5, prefix-SID index 5, R:0 N:1 P:0 E:0 V:0 L:0, Alg:0\nRP/0/RP0/CPU0:P2#\nRP/0/RP0/CPU0:P2#show route 5.5.5.5/32\nWed Feb  1 12:18:17.246 UTC\nRouting entry for 5.5.5.5/32\nKnown via \"isis IGP\", distance 115, metric 30, labeled SR, type level-2\nInstalled Feb  1 12:17:48.449 for 00:00:28\nRouting Descriptor Blocks\n23.0.0.3, from 5.5.5.5, via GigabitEthernet0/0/0/0, Protected\nRoute metric is 30\n27.0.0.7, from 5.5.5.5, via GigabitEthernet0/0/0/3, Backup (TI-LFA)\nRepair Node(s): 7.7.7.7, 4.4.4.4\nRoute metric is 120\nNo advertising protos.\nRP/0/RP0/CPU0:P2#\nRP/0/RP0/CPU0:P2#show cef 5.5.5.5/32\nWed Feb  1 12:18:22.190 UTC\n5.5.5.5/32, version 1388, labeled SR, internal 0x1000001 0x8310 (ptr 0xe727de0) [1], 0x600 (0xe191460), 0xa28 (0xf559ec0)\nUpdated Feb  1 12:17:48.453\nremote adjacency to GigabitEthernet0/0/0/0\nPrefix Len 32, traffic index 0, precedence n/a, priority 1\ngateway array (0xdffa4a0) reference count 6, flags 0x500068, source rib (7), 1 backups\n[5 type 4 flags 0x8401 (0xeb744e8) ext 0x0 (0x0)]\nLW-LDI[type=1, refc=1, ptr=0xe191460, sh-ldi=0xeb744e8]\ngateway array update type-time 1 Feb  1 12:17:48.453\nLDI Update time Feb  1 12:17:48.455\nLW-LDI-TS Feb  1 12:17:48.455\nvia 23.0.0.3/32, GigabitEthernet0/0/0/0, 8 dependencies, weight 0, class 0, protected [flags 0x400]\npath-idx 0 bkup-idx 1 NHID 0x0 [0xdda6db0 0xdda6db0]\nnext hop 23.0.0.3/32\nlocal label 16005      labels imposed {16005}\nvia 27.0.0.7/32, GigabitEthernet0/0/0/3, 8 dependencies, weight 0, class 0, backup (TI-LFA) [flags 0xb00]\npath-idx 1 NHID 0x0 [0xf39a4b0 0x0]\nnext hop 27.0.0.7/32, Repair Node(s): 7.7.7.7, 4.4.4.4\nremote adjacency\nlocal label 16005      labels imposed {ImplNull 24014 16005}\nLoad distribution: 0 (refcount 5)\nHash  OK  Interface                 Address\n0     Y   GigabitEthernet0/0/0/0    remote\nRP/0/RP0/CPU0:P2#\n</code></pre>"},{"location":"tilfa_local_srlg/","title":"TI-LFA Local SRLG Disjoint Protection","text":"TI-LFA Local SRLG Disjoint Protection <p>When two or more connections share a common transmission risk, they constitute an SRLG (Share Risk Link Group). Once identified, the SRLGs are applied to the appropriate router interfaces.</p> <p>The local SRLG disjoint is covered in this part, but the SRLG-based TI-LFA backup path just analyses the directly linked SRLG connections.</p> <p>There is an SRLG on P2 in the aforementioned topology for the P2 - P7 and P2 - P3 links.</p> <p>Create an SRLG group called SRLG-100 and give it the value 100. Configure a fast-reroute tiebreaker for srlg to allow P2 to avoid using SRLG as a backup route.</p>"},{"location":"tilfa_local_srlg/#configuration","title":"Configuration","text":"P2 <pre><code>srlg\ninterface GigabitEthernet0/0/0/0\nname SRLG-100\n!\ninterface GigabitEthernet0/0/0/3\nname SRLG-100\n!\nname SRLG-100 value 100\n!\nrouter isis IGP\naddress-family ipv4 unicast\nfast-reroute per-prefix tiebreaker srlg-disjoint index 100\n</code></pre>"},{"location":"tilfa_local_srlg/#verify","title":"Verify","text":"<p>P6 is located in P-space (or P-node) (P2 can send the traffic to P6 without any risk of flowing via P2 \u2013 P3)</p> <p>P7 is located in Q-space (or Q-node) (P7 can send the traffic to the destination without any risk of flowing via P2 \u2013 P3)</p> <p>The backup path on P2 reveals that an extra Adj-SID label 24019 is sent towards P6, which is the link between P6 and P7, to compel the router to use that link for traffic forwarding.</p> <p>In this case, P7 would utilise the P3 node to forward traffic because it is the shortest path to the target.</p> Local SRLG Disjoint Protection TI-LFA <pre><code>RP/0/RP0/CPU0:P2#show isis fast-reroute 5.5.5.5/32 detail\nWed Feb  1 09:09:37.951 UTC\nL2 5.5.5.5/32 [30/115] Label: 16005, medium priority\nInstalled Feb 01 09:09:22.424 for 00:00:16\nvia 23.0.0.3, GigabitEthernet0/0/0/0, Label: 16005, P3, SRGB Base: 16000, Weight: 0\nBackup path: TI-LFA (srlg), via 26.0.0.6, GigabitEthernet0/0/0/1 P6, SRGB Base: 16000, Weight: 0, Metric: 140\nP node: P6.00 [6.6.6.6], Label: ImpNull\nQ node: P7.00 [7.7.7.7], Label: 24019\nPrefix label: 16005\nBackup-src: PE5.00\nP: No, TM: 140, LC: No, NP: No, D: No, SRLG: Yes\nsrc PE5.00-00, 5.5.5.5, prefix-SID index 5, R:0 N:1 P:0 E:0 V:0 L:0, Alg:0\nRP/0/RP0/CPU0:P2#\n</code></pre>"},{"location":"tilfa_node/","title":"TI-LFA Node Protection","text":"TI-LFA Node Protection <p>Configure P2 in the topology for node protection such that the backup route bypasses P3 for the primary connection P2 - P3 to reach the destination PE5.</p>"},{"location":"tilfa_node/#configuration","title":"Configuration","text":"P2 <pre><code>router isis IGP\naddress-family ipv4 unicast\nfast-reroute per-prefix tiebreaker node-protecting index 200\n</code></pre> <p>P7 is located in P-space (or P-node) (P2 can send the traffic to P7 without any risk of flowing it via P2 \u2013 P3)</p> <p>P4 is located in Q-space (or Q-node) (P4 can send the traffic to the destination without any risk of it flowing through P2 \u2013 P3)</p>"},{"location":"tilfa_node/#verify","title":"Verify","text":"<p>The shortest route from P7 to PE5 is through P3.</p> <p>Because node protection is enabled on P2, it constructs a backup path that bypasses P3.</p> <p>As a result, P2's backup route has the Adj-SID label 24014, which is the Adj-SID label for P7 - P4.</p> Node Protection TI-LFA <pre><code>RP/0/RP0/CPU0:P2#sh isis fast-reroute 5.5.5.5/32 detail\nWed Feb  1 08:16:00.944 UTC\nL2 5.5.5.5/32 [30/115] Label: 16005, medium priority\nInstalled Feb 01 08:15:51.907 for 00:00:10\nvia 23.0.0.3, GigabitEthernet0/0/0/0, Label: 16005, P3, SRGB Base: 16000, Weight: 0\nBackup path: TI-LFA (node), via 27.0.0.7, GigabitEthernet0/0/0/3 P7, SRGB Base: 16000, Weight: 0, Metric: 120\nP node: P7.00 [7.7.7.7], Label: ImpNull\nQ node: P4.00 [4.4.4.4], Label: 24014\nPrefix label: 16005\nBackup-src: PE5.00\nP: No, TM: 120, LC: No, NP: Yes, D: No, SRLG: Yes\nsrc PE5.00-00, 5.5.5.5, prefix-SID index 5, R:0 N:1 P:0 E:0 V:0 L:0, Alg:0\nRP/0/RP0/CPU0:P2#\n</code></pre>"},{"location":"tilfa_node/#restore-topology","title":"Restore Topology","text":"Remove Node Protection (P2) <pre><code>router isis IGP\naddress-family ipv4 unicast\nno fast-reroute per-prefix tiebreaker node-protecting index 200\n</code></pre>"},{"location":"tilfa_node_srlg/","title":"TI-LFA Node + SRLG Protection","text":"TI-LFA Node + SRLG Protection <p>Enabling Node + SRLG protection on P2 in the aforementioned architecture would cause it to avoid the SRLG connections as well as the P3 node for its backup route to the destination.</p> <p>Because SRLG is already present from the previous step, enable node protection.</p>"},{"location":"tilfa_node_srlg/#configuration","title":"Configuration","text":"P2 <pre><code>router isis IGP\naddress-family ipv4 unicast\nfast-reroute per-prefix tiebreaker node-protecting index 200\n</code></pre>"},{"location":"tilfa_node_srlg/#verify","title":"Verify","text":"<p>P2 now computes a backup route that avoids the SRLG connections, so it travels to P6 - P7 and avoids P3 owing to node protection, so it uses P7 - P4.</p> <p>P6 is located in P-space (or P-node) (P2 can send the traffic to P6 without any risk of flowing it via P2 \u2013 P3)</p> <p>P7 is located in Q-space (or Q-node) (P7 can send the traffic to the destination without any risk of flowing via P2 \u2013P3)</p> <p>P4 is located in Q-space (or Q-node) (P4 can send the traffic to the destination without any risk of flowing via P2 \u2013 P3)</p> <p>Because the post-convergence path route has a high metric, P2 generates a backup route, forcing traffic to take the high metric connections.</p> <p>The backup route, on the other hand, now has three labels, whereas TI-LFA only supports two labels. As a result, the SR auto-tunnel is initiated as a backup path.</p> Node + SRLG Protection TI-LFA <pre><code>RP/0/RP0/CPU0:P2(config)#do sh isis fast-reroute 5.5.5.5/32 detail\nWed Feb  1 09:47:46.311 UTC\nL2 5.5.5.5/32 [30/115] Label: 16005, medium priority\nInstalled Feb 01 09:47:43.868 for 00:00:03\nvia 23.0.0.3, GigabitEthernet0/0/0/0, Label: 16005, P3, SRGB Base: 16000, Weight: 0\nBackup path: TI-LFA (node+srlg), via 26.0.0.6, GigabitEthernet0/0/0/1 P6, SRGB Base: 16000, Weight: 0, Metric: 220\nBackup tunnel: tunnel-te32772\nP node: P6.00 [6.6.6.6], Label: ImpNull\nQ node: P7.00 [7.7.7.7], Label: 24019\nQ node: P4.00 [4.4.4.4], Label: 24014\nPrefix label: 16005\nBackup-src: PE5.00\nP: No, TM: 220, LC: No, NP: Yes, D: No, SRLG: Yes\nsrc PE5.00-00, 5.5.5.5, prefix-SID index 5, R:0 N:1 P:0 E:0 V:0 L:0, Alg:0\nRP/0/RP0/CPU0:P2(config)#\nRP/0/RP0/CPU0:P2(config)#do sh cef 5.5.5.5/32\nWed Feb  1 09:48:34.746 UTC\n5.5.5.5/32, version 1247, labeled SR, internal 0x1000001 0x8310 (ptr 0xe727de0) [1], 0x600 (0xe190578), 0xa28 (0xf55a020)\nUpdated Feb  1 09:47:43.873\nremote adjacency to GigabitEthernet0/0/0/0\nPrefix Len 32, traffic index 0, precedence n/a, priority 1\ngateway array (0xdffa100) reference count 3, flags 0x500068, source rib (7), 1 backups\n[2 type 5 flags 0x8401 (0xeb74428) ext 0x0 (0x0)]\nLW-LDI[type=5, refc=3, ptr=0xe190578, sh-ldi=0xeb74428]\ngateway array update type-time 1 Feb  1 09:47:43.873\nLDI Update time Feb  1 09:47:43.873\nLW-LDI-TS Feb  1 09:47:43.873\nvia 0.0.0.0/32, tunnel-te32772, 9 dependencies, weight 0, class 0, backup (Local-LFA) [flags 0x300]\npath-idx 0 NHID 0x0 [0xf399e70 0x0]\nnext hop 0.0.0.0/32\nlocal adjacency\nlocal label 16005      labels imposed {16005}\nvia 23.0.0.3/32, GigabitEthernet0/0/0/0, 8 dependencies, weight 0, class 0, protected [flags 0x400]\npath-idx 1 bkup-idx 0 NHID 0x0 [0xdda6180 0x0]\nnext hop 23.0.0.3/32\nlocal label 16005      labels imposed {16005}\nLoad distribution: 0 (refcount 2)\nHash  OK  Interface                 Address\n0     Y   GigabitEthernet0/0/0/0    remote\nRP/0/RP0/CPU0:P2(config)#\nRP/0/RP0/CPU0:P2(config)#do sh mpls traffic-eng tunnels 32772\nWed Feb  1 09:52:05.595 UTC\nName: tunnel-te32772  Destination: 0.0.0.0  Ifhandle:0x4c (auto-tunnel for ISIS IGP)\nSignalled-Name: auto_P2_t32772\nStatus:\nAdmin:    up Oper:   up   Path:  valid   Signalling: connected\npath option (_te32772), preference 10, (verbatim Segment-Routing) type explicit (_te32772) (Basis for Setup)\nG-PID: 0x0800 (derived from egress interface properties)\nBandwidth Requested: 0 kbps  CT0\nCreation Time: Wed Feb  1 09:47:43 2023 (00:04:22 ago)\nConfig Parameters:\nBandwidth:        0 kbps (CT0) Priority:  7  7 Affinity: 0x0/0xffff\nMetric Type: TE (global)\nPath Selection:\nTiebreaker: Min-fill (default)\nProtection: any (default)\nHop-limit: disabled\nCost-limit: disabled\nDelay-limit: disabled\nDelay-measurement: disabled\nPath-invalidation timeout: 10000 msec (default), Action: Tear (default)\nAutoRoute: disabled  LockDown: disabled   Policy class: not set\nForward class: 0 (not enabled)\nForwarding-Adjacency: disabled\nAutoroute Destinations: 0\nLoadshare:          0 equal loadshares\nAuto-bw: disabled\nAuto-Capacity: Disabled:\nPath Protection: Not Enabled\nBFD Fast Detection: Disabled\nReoptimization after affinity failure: Enabled\nSRLG discovery: Disabled\nHistory:\nTunnel has been up for: 00:04:22 (since Wed Feb 01 09:47:43 UTC 2023)\nCurrent LSP:\nUptime: 00:04:22 (since Wed Feb 01 09:47:43 UTC 2023)\nSegment-Routing Path Info (IGP information is not used)\nSegment0[First Hop]: 26.0.0.6, Label: -\nSegment1[ - ]: Label: 24019\nSegment2[ - ]: Label: 24014\nDisplayed 1 (of 1) heads, 0 (of 0) midpoints, 0 (of 0) tails\nDisplayed 1 up, 0 down, 0 recovering, 0 recovered heads\nRP/0/RP0/CPU0:P2(config)#\n</code></pre>"},{"location":"tilfa_node_srlg_prep/","title":"TI-LFA Node and SRLG Protection","text":"TI-LFA Node and SRLG Protection Topology <p>By default, TI-LFA allows link protection; to activate it for node protection and srlg, a fast-reroute tiebreaker is necessary. Link protection is already seen in instances of Single Segment TI-LFA and Double Segment TI-LFA.</p> <p>As a first step, raise the metric on the P6 - P7 and P7 - P4 links to 100 and disable peering on P8 to isolate it from the network.</p> P6P7P4P8 <pre><code>router isis IGP\ninterface GigabitEthernet0/0/0/0\naddress-family ipv4 unicast\nmetric 100\n</code></pre> <pre><code>router isis IGP\ninterface GigabitEthernet0/0/0/0\naddress-family ipv4 unicast\nmetric 100\n!\n!\ninterface GigabitEthernet0/0/0/4\naddress-family ipv4 unicast\nmetric 100\n</code></pre> <pre><code>router isis IGP\ninterface GigabitEthernet0/0/0/4\naddress-family ipv4 unicast\nmetric 100\n</code></pre> <pre><code>router isis IGP\ninterface GigabitEthernet0/0/0/1\nshutdown\n!\ninterface GigabitEthernet0/0/0/2\nshutdown\n</code></pre>"},{"location":"zs_tilfa/","title":"Zero Segment TI-LFA (Topology Independent - LoopFree Alternate)","text":"Zero Segment TI-LFA <p>The Zero Segment TI-LFA backup route allows the router, in the event of a local failure, to transfer traffic through a backup connection without adding any further segments to the original packet.</p>"},{"location":"zs_tilfa/#prepare-the-topology","title":"Prepare the topology","text":"<p>Increase the metric between P2 - P6 and P2 - P7 in the illustrated topology to 100, while all other links have the default metric of 10.</p> <p>To protect the link between P2 and P3, the P2 router now has a backup route via P7 to PE5, which is the post-convergence path in the case of the aforementioned link failure.</p> P2P6P7 <pre><code>router isis IGP\ninterface GigabitEthernet0/0/0/1\naddress-family ipv4 unicast\nmetric 100\n!\n!\ninterface GigabitEthernet0/0/0/3\naddress-family ipv4 unicast\nmetric 100\n</code></pre> <pre><code>router isis IGP\ninterface GigabitEthernet0/0/0/1\naddress-family ipv4 unicast\nmetric 100\n</code></pre> <pre><code>router isis IGP\ninterface GigabitEthernet0/0/0/3\naddress-family ipv4 unicast\nmetric 100\n</code></pre>"},{"location":"zs_tilfa/#verify","title":"Verify","text":"<p>The backup is via P7, with no additional label applied, because P7 can reach PE5 without traversing the P2 - P3 link, which would also become the post-convergence path for P2 to PE5 in the event of a local failure towards P3.</p> <p>P2 may give over the original segment, which is the Prefix-SID of PE5, to its immediate neighbour P7, it can then forward it to PE5 without risk of it travelling across the P2 - P3 link. As a result, no extra segment was enforced to direct traffic to the backup route.</p> Zero Segment TI-LFA <p>Zero Segment TI-LFA</p> <p>No additional segment required in the backup path.</p> <pre><code>RP/0/RP0/CPU0:P2#show isis route 5.5.5.5/32 detail\nWed Feb  1 07:25:32.432 UTC\nL2 5.5.5.5/32 [30/115] Label: 16005, medium priority\nInstalled Feb 01 07:24:43.731 for 00:00:49\nvia 23.0.0.3, GigabitEthernet0/0/0/0, Label: 16005, P3, SRGB Base: 16000, Weight: 0\nsrc PE5.00-00, 5.5.5.5, prefix-SID index 5, R:0 N:1 P:0 E:0 V:0 L:0, Alg:0\nRP/0/RP0/CPU0:P2#\nRP/0/RP0/CPU0:P2#show isis fast-reroute 5.5.5.5/32 detail\nWed Feb  1 07:25:46.923 UTC\nL2 5.5.5.5/32 [30/115] Label: 16005, medium priority\nInstalled Feb 01 07:24:43.731 for 00:01:04\nvia 23.0.0.3, GigabitEthernet0/0/0/0, Label: 16005, P3, SRGB Base: 16000, Weight: 0\nBackup path: LFA, via 27.0.0.7, GigabitEthernet0/0/0/3, Label: 16005, P7, SRGB Base: 16000, Weight: 0, Metric: 120\nP: No, TM: 120, LC: No, NP: Yes, D: Yes, SRLG: Yes\nsrc PE5.00-00, 5.5.5.5, prefix-SID index 5, R:0 N:1 P:0 E:0 V:0 L:0, Alg:0\nRP/0/RP0/CPU0:P2#\nRP/0/RP0/CPU0:P2#show route 5.5.5.5/32\nWed Feb  1 07:25:55.436 UTC\nRouting entry for 5.5.5.5/32\nKnown via \"isis IGP\", distance 115, metric 30, labeled SR, type level-2\nInstalled Feb  1 07:24:43.732 for 00:01:11\nRouting Descriptor Blocks\n23.0.0.3, from 5.5.5.5, via GigabitEthernet0/0/0/0, Protected\nRoute metric is 30\n27.0.0.7, from 5.5.5.5, via GigabitEthernet0/0/0/3, Backup (Local-LFA)\nRoute metric is 120\nNo advertising protos.\nRP/0/RP0/CPU0:P2#\nRP/0/RP0/CPU0:P2#show cef 5.5.5.5/32\nWed Feb  1 07:26:07.812 UTC\n5.5.5.5/32, version 344, labeled SR, internal 0x1000001 0x8310 (ptr 0xe727de0) [1], 0x600 (0xe190578), 0xa28 (0xf54a1b0)\nUpdated Feb  1 07:24:43.736\nremote adjacency to GigabitEthernet0/0/0/0\nPrefix Len 32, traffic index 0, precedence n/a, priority 1\ngateway array (0xdff8a58) reference count 9, flags 0x500068, source rib (7), 1 backups\n[4 type 5 flags 0x8401 (0xeb73e88) ext 0x0 (0x0)]\nLW-LDI[type=5, refc=3, ptr=0xe190578, sh-ldi=0xeb73e88]\ngateway array update type-time 1 Feb  1 07:24:43.735\nLDI Update time Feb  1 07:24:43.735\nLW-LDI-TS Feb  1 07:24:43.736\nvia 23.0.0.3/32, GigabitEthernet0/0/0/0, 14 dependencies, weight 0, class 0, protected [flags 0x400]\npath-idx 0 bkup-idx 1 NHID 0x0 [0xdda5280 0x0]\nnext hop 23.0.0.3/32\nlocal label 16005      labels imposed {16005}\nvia 27.0.0.7/32, GigabitEthernet0/0/0/3, 12 dependencies, weight 0, class 0, backup (Local-LFA) [flags 0x300]\npath-idx 1 NHID 0x0 [0xf399ab0 0x0]\nnext hop 27.0.0.7/32\nremote adjacency\nlocal label 16005      labels imposed {16005}\nLoad distribution: 0 (refcount 4)\nHash  OK  Interface                 Address\n0     Y   GigabitEthernet0/0/0/0    remote\nRP/0/RP0/CPU0:P2#\n</code></pre>"},{"location":"zs_tilfa/#restore-the-metrics","title":"Restore the metrics","text":"<p>Before moving on to the next lab, restore the metric.</p> P2P6P7 <pre><code>router isis IGP\ninterface GigabitEthernet0/0/0/1\naddress-family ipv4 unicast\nmetric 10\n!\n!\ninterface GigabitEthernet0/0/0/3\naddress-family ipv4 unicast\nmetric 10\n</code></pre> <pre><code>router isis IGP\ninterface GigabitEthernet0/0/0/1\naddress-family ipv4 unicast\nmetric 10\n</code></pre> <pre><code>router isis IGP\ninterface GigabitEthernet0/0/0/3\naddress-family ipv4 unicast\nmetric 10\n</code></pre>"}]}